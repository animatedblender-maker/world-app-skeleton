import{a as F,b as L}from"./chunk-P7CU2M4L.js";import{a as R}from"./chunk-XEM7RPTP.js";import{a as I,b as A,e as T,g as D,h as U,i as q,m as z}from"./chunk-OOQ5NGO6.js";import"./chunk-NOJK5XQQ.js";import{$ as r,B as l,Ba as O,E as u,F as x,J as g,N as d,O as a,P as n,V as P,W as f,X as y,aa as p,ba as v,da as h,ea as C,fa as _,ma as w,p as b,pa as M,q as S,qa as N,ua as E,ya as k}from"./chunk-XHC7PKXJ.js";function B(c,i){c&1&&(a(0,"small",21),r(1,"Selected \u2705"),n())}function W(c,i){if(c&1&&(a(0,"option",25),r(1),n()),c&2){let t=i.$implicit;d("value",t.name),l(),p(t.name)}}function V(c,i){if(c&1){let t=P();a(0,"div",4)(1,"label"),r(2,"Manual country"),n(),a(3,"select",22),_("ngModelChange",function(o){b(t);let s=y();return C(s.manualCountryName,o)||(s.manualCountryName=o),S(o)}),a(4,"option",23),r(5,"Select\u2026"),n(),g(6,W,2,2,"option",24),n(),a(7,"small",21),r(8,"Used only if auto-detect fails."),n()()}if(c&2){let t=y();l(3),h("ngModel",t.manualCountryName),l(3),d("ngForOf",t.countries)}}function $(c,i){if(c&1&&(a(0,"div",26),r(1),n()),c&2){let t=y();l(),p(t.msg)}}var j=class c{constructor(i,t,e,o,s,m){this.auth=i;this.countriesService=t;this.gql=e;this.media=o;this.router=s;this.cdr=m}countries=[];displayName="";avatarUrl=null;detecting=!1;detectSource="";countryName="";countryCode="";cityName="";manual=!1;manualCountryName="";busy=!1;msg="";async ngOnInit(){let i=await this.auth.getUser();if(!i){await this.router.navigateByUrl("/auth");return}this.displayName=i.email?.split("@")[0]??"User";let t=await this.countriesService.loadCountries();this.countries=t.countries??[],this.cdr.detectChanges(),queueMicrotask(()=>this.detect())}async onAvatar(i){let t=i.target,e=t.files?.[0];if(e){this.msg="";try{let o=await this.media.uploadAvatar(e);this.avatarUrl=o.url}catch(o){this.msg=`Avatar upload failed: ${o?.message??o}`}finally{t.value="",this.cdr.detectChanges()}}}async detect(){this.msg="",this.detecting=!0,this.detectSource="";try{let i=await this.getBrowserCoords(9e3);if(!i){this.manual=!0,this.detectSource="gps denied/timeout";return}let e=(await this.gql.query(`
        mutation Detect($lat: Float!, $lng: Float!) {
          detectLocation(lat: $lat, lng: $lng) {
            countryCode
            countryName
            cityName
            source
          }
        }
        `,{lat:i.lat,lng:i.lng})).detectLocation;this.countryName=e.countryName,this.countryCode=e.countryCode,this.cityName=e.cityName??"",this.detectSource=e.source,this.manual=!1}catch(i){this.manual=!0,this.detectSource="detect failed",this.msg=i?.message??String(i)}finally{this.detecting=!1,this.cdr.detectChanges()}}async save(){this.msg="",this.busy=!0;try{let i=this.displayName.trim();if(!i)throw new Error("Screen name is required.");let t=(this.countryName||"").trim(),e=(this.countryCode||"").trim(),o=(this.cityName||"").trim();if(!t||t==="Unknown"){if(!this.manualCountryName)throw new Error("Auto-detect failed. Select a country manually.");t=this.manualCountryName,e="",o=""}await this.gql.query(`
        mutation Update($input: UpdateProfileInput!) {
          updateProfile(input: $input) { user_id }
        }
        `,{input:{display_name:i,avatar_url:this.avatarUrl,country_name:t,country_code:e||null,city_name:o||null}}),await this.router.navigateByUrl("/")}catch(i){this.msg=i?.message??String(i)}finally{this.busy=!1,this.cdr.detectChanges()}}getBrowserCoords(i){return new Promise(t=>{if(!("geolocation"in navigator))return t(null);let e=!1,o=m=>{e||(e=!0,t(m))},s=window.setTimeout(()=>o(null),i);navigator.geolocation.getCurrentPosition(m=>{clearTimeout(s),o({lat:m.coords.latitude,lng:m.coords.longitude})},()=>{clearTimeout(s),o(null)},{enableHighAccuracy:!1,timeout:i,maximumAge:6e4})})}static \u0275fac=function(t){return new(t||c)(u(O),u(F),u(L),u(R),u(k),u(w))};static \u0275cmp=x({type:c,selectors:[["app-profile-setup-page"]],decls:47,vars:12,consts:[[1,"wrap"],[1,"card"],[1,"title"],[1,"sub"],[1,"field"],["placeholder","e.g. Amr",3,"ngModelChange","ngModel"],[1,"row"],[1,"btn2",2,"cursor","pointer"],["type","file","accept","image/*",2,"display","none",3,"change"],["class","muted",4,"ngIf"],[1,"locbox"],[1,"locrow"],[1,"k"],[1,"v"],[1,"row",2,"margin-top","10px"],["type","button",1,"btn2",3,"click","disabled"],["type","button",1,"link",3,"click"],["class","field",4,"ngIf"],[1,"row",2,"margin-top","16px"],[1,"btn",3,"click","disabled"],["class","msg",4,"ngIf"],[1,"muted"],[3,"ngModelChange","ngModel"],["value",""],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"msg"]],template:function(t,e){t&1&&(a(0,"div",0)(1,"div",1)(2,"div",2),r(3,"Create your profile"),n(),a(4,"div",3),r(5,"Auto-detect is default. Manual selection is fallback."),n(),a(6,"div",4)(7,"label"),r(8,"Screen name"),n(),a(9,"input",5),_("ngModelChange",function(s){return C(e.displayName,s)||(e.displayName=s),s}),n()(),a(10,"div",4)(11,"label"),r(12,"Avatar (optional)"),n(),a(13,"div",6)(14,"label",7),r(15," Choose image "),a(16,"input",8),f("change",function(s){return e.onAvatar(s)}),n()(),g(17,B,2,0,"small",9),n()(),a(18,"div",4)(19,"label"),r(20,"Detected location"),n(),a(21,"div",10)(22,"div",11)(23,"div",12),r(24,"Country"),n(),a(25,"div",13),r(26),n()(),a(27,"div",11)(28,"div",12),r(29,"City"),n(),a(30,"div",13),r(31),n()(),a(32,"div",11)(33,"div",12),r(34,"Status"),n(),a(35,"div",13),r(36),n()()(),a(37,"div",14)(38,"button",15),f("click",function(){return e.detect()}),r(39),n(),a(40,"button",16),f("click",function(){return e.manual=!e.manual}),r(41),n()()(),g(42,V,9,2,"div",17),a(43,"div",18)(44,"button",19),f("click",function(){return e.save()}),r(45),n(),g(46,$,2,1,"div",20),n()()()),t&2&&(l(9),h("ngModel",e.displayName),l(8),d("ngIf",e.avatarUrl),l(9),p(e.countryName||"\u2014"),l(5),p(e.cityName||"\u2014"),l(5),p(e.detecting?"Detecting\u2026":e.detectSource||"\u2014"),l(2),d("disabled",e.detecting),l(),v(" ",e.detecting?"Detecting\u2026":"Detect again"," "),l(2),v(" ",e.manual?"Hide manual":"Manual fallback"," "),l(),d("ngIf",e.manual),l(2),d("disabled",e.busy),l(),v(" ",e.busy?"Saving\u2026":"Save & Continue"," "),l(),d("ngIf",e.msg))},dependencies:[E,M,N,z,U,q,I,D,A,T],styles:["[_nghost-%COMP%]{display:block;height:100vh}.wrap[_ngcontent-%COMP%]{height:100vh;display:grid;place-items:center;background:radial-gradient(1200px 800px at 50% 30%,rgba(0,255,209,.1),transparent 60%),#06080ef2;color:#ffffffeb}.card[_ngcontent-%COMP%]{width:min(720px,92vw);border-radius:24px;padding:18px;background:#0a0c1499;border:1px solid rgba(0,255,209,.2);box-shadow:0 30px 90px #00000073;-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px)}.title[_ngcontent-%COMP%]{font-weight:900;letter-spacing:.08em;font-size:18px}.sub[_ngcontent-%COMP%]{margin-top:6px;opacity:.7;font-size:13px}.field[_ngcontent-%COMP%]{margin-top:14px;display:grid;gap:8px}label[_ngcontent-%COMP%]{font-size:12px;opacity:.75;letter-spacing:.12em}input[_ngcontent-%COMP%], select[_ngcontent-%COMP%]{padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:#00000047;color:#ffffffeb;outline:none}.locbox[_ngcontent-%COMP%]{border:1px solid rgba(255,255,255,.1);background:#0003;border-radius:16px;padding:12px;display:grid;gap:8px}.locrow[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:12px}.k[_ngcontent-%COMP%]{opacity:.7;font-size:12px}.v[_ngcontent-%COMP%]{font-weight:800;font-size:13px}.row[_ngcontent-%COMP%]{display:flex;gap:12px;align-items:center}.muted[_ngcontent-%COMP%]{opacity:.65;font-weight:600;font-size:12px}.btn[_ngcontent-%COMP%]{border:0;border-radius:16px;padding:12px 14px;cursor:pointer;background:linear-gradient(90deg,#00ffd1d9,#8c00ffbf);color:#06080ef5;font-weight:900;letter-spacing:.12em}.btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.btn2[_ngcontent-%COMP%]{border:1px solid rgba(255,255,255,.14);background:#ffffff0f;color:#ffffffe6;padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:900;letter-spacing:.08em;font-size:12px}.link[_ngcontent-%COMP%]{border:0;background:transparent;padding:0;color:#00ffd1e6;cursor:pointer;font-weight:900;letter-spacing:.08em;font-size:12px}.msg[_ngcontent-%COMP%]{font-size:13px;opacity:.95;white-space:pre-wrap}"]})};export{j as ProfileSetupPageComponent};
