import{a as E}from"./chunk-YDPXGYO4.js";import{b as B}from"./chunk-YRPTNGKR.js";import"./chunk-VEHW3HLT.js";import"./chunk-YQ2TA2FF.js";import"./chunk-LJDR2ADK.js";import"./chunk-7DJA5TI4.js";import{a as R}from"./chunk-AFJFBD4M.js";import"./chunk-LQQHCQP3.js";import"./chunk-KO5X6LCN.js";import{$ as k,Da as I,G as l,H as w,Ia as L,Q as p,R as m,S as f,Y as x,Z as _,aa as M,ba as O,fa as g,p as v,q as P,v as S}from"./chunk-SPQ2JWKS.js";import"./chunk-2NFLSA4Y.js";var z=["cesiumContainer"],D=class h{constructor(t,i,e,o){this.zone=t;this.router=i;this.countriesService=e;this.presence=o}containerRef;viewer=null;pointsSource=null;lastPointsTs=0;async ngAfterViewInit(){this.zone.runOutsideAngular(async()=>{let t=await this.ensureCesium();if(!t)return;let i=this.containerRef?.nativeElement;if(!i)return;let e=new t.Viewer(i,{animation:!1,timeline:!1,geocoder:!1,homeButton:!1,baseLayerPicker:!1,sceneModePicker:!1,navigationHelpButton:!1,infoBox:!1,selectionIndicator:!1,fullscreenButton:!1,shouldAnimate:!0}),o=new URL("./",document.baseURI).toString(),c=new t.SingleTileImageryProvider({url:new URL("earth-day-8k.jpg?v=4",o).toString(),rectangle:t.Rectangle.fromDegrees(-180,-90,180,90),credit:"Solar System Scope"}),n=new t.SingleTileImageryProvider({url:new URL("earth-clouds-8k.jpg?v=3",o).toString(),rectangle:t.Rectangle.fromDegrees(-180,-90,180,90),credit:"Solar System Scope"}),r=new t.UrlTemplateImageryProvider({url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",credit:"\xA9 OpenStreetMap contributors"});e.imageryLayers.removeAll();let u=e.imageryLayers.addImageryProvider(c),C=e.imageryLayers.addImageryProvider(n),b=e.imageryLayers.addImageryProvider(r);b.alpha=0,C.alpha=.45,e.scene.globe.enableLighting=!1,e.scene.globe.maximumScreenSpaceError=1.25,e.scene.globe.baseColor=t.Color.fromCssColorString("#0b2a3b"),e.scene.backgroundColor=t.Color.fromCssColorString("#0b2a3b"),e.scene.skyAtmosphere.show=!1,e.scene.globe.showGroundAtmosphere=!1,e.scene.postProcessStages.fxaa.enabled=!0,e.resolutionScale=Math.min(2,window.devicePixelRatio||1),e.cesiumWidget.creditContainer?.classList.add("cesium-credit-compact"),e.scene.skyBox=void 0;try{let a=t.PostProcessStageLibrary.createBrightnessStage();a.uniforms.brightness=1.06;let s=t.PostProcessStageLibrary.createContrastStage();s.uniforms.contrast=1.12;let d=t.PostProcessStageLibrary.createSaturationStage();d.uniforms.saturation=.92,e.scene.postProcessStages.add(a),e.scene.postProcessStages.add(s),e.scene.postProcessStages.add(d)}catch{}u.alpha=1;let y=()=>{let a=e.camera.positionCartographic.height,s=t.Math.clamp((a-3e5)/25e5,0,1),d=.1+.9*(1-s),T=.35+.65*s,N=.2+.35*s;b.alpha=d,u.alpha=T,C.alpha=N};y(),e.camera.changed.addEventListener(y),e.scene.screenSpaceCameraController.maximumZoomDistance=6e7,e.scene.screenSpaceCameraController.minimumZoomDistance=6e5,this.viewer=e,this.pointsSource=new t.CustomDataSource("presence"),e.dataSources.add(this.pointsSource);try{let a=await t.GeoJsonDataSource.load("assets/countries50m.geojson",{stroke:t.Color.fromCssColorString("#2a4c66"),fill:t.Color.fromCssColorString("#0b273d").withAlpha(.25),strokeWidth:1});e.dataSources.add(a),a.entities.values.forEach(s=>{s.polygon&&(s.polygon.outline=!0,s.polygon.outlineColor=t.Color.fromCssColorString("#2a4c66"))})}catch{}let A=await this.countriesService.loadCountries();try{await this.presence.start({countries:A.countries,onUpdate:a=>{this.updatePoints(t,a.points)}})}catch{}})}ngOnDestroy(){try{this.presence.stop()}catch{}if(this.viewer){try{this.viewer.destroy()}catch{}this.viewer=null}}goBack(){this.router.navigate(["/globe"])}updatePoints(t,i){if(!this.pointsSource)return;let e=Date.now();if(!(e-this.lastPointsTs<600)){this.lastPointsTs=e,this.pointsSource.entities.removeAll();for(let o of i){let c=Number(o.lat),n=Number(o.lng);if(!Number.isFinite(c)||!Number.isFinite(n))continue;let r=Math.max(2,Math.round((o.radius??1.2)*1.8)),u=t.Color.fromCssColorString(o.color||"rgba(0,255,209,0.92)");this.pointsSource.entities.add({position:t.Cartesian3.fromDegrees(n,c),point:{pixelSize:r,color:u,outlineColor:t.Color.fromCssColorString("#04141f"),outlineWidth:1,heightReference:t.HeightReference.CLAMP_TO_GROUND}})}}}ensureCesium(){let t=window;return t.Cesium?Promise.resolve(t.Cesium):new Promise((i,e)=>{t.CESIUM_BASE_URL="https://unpkg.com/cesium@1.116.0/Build/Cesium/";let o="cesium-widgets-css";if(!document.getElementById(o)){let r=document.createElement("link");r.id=o,r.rel="stylesheet",r.href="https://unpkg.com/cesium@1.116.0/Build/Cesium/Widgets/widgets.css",document.head.appendChild(r)}let c="cesium-lib";if(document.getElementById(c)){let r=window.Cesium;r&&i(r);return}let n=document.createElement("script");n.id=c,n.src="https://unpkg.com/cesium@1.116.0/Build/Cesium/Cesium.js",n.async=!0,n.onload=()=>i(window.Cesium),n.onerror=()=>e(new Error("Failed to load Cesium")),document.head.appendChild(n)})}static \u0275fac=function(i){return new(i||h)(l(S),l(L),l(R),l(E))};static \u0275cmp=w({type:h,selectors:[["app-globe-cesium-page"]],viewQuery:function(i,e){if(i&1&&k(z,7),i&2){let o;M(o=O())&&(e.containerRef=o.first)}},decls:11,vars:0,consts:[["cesiumContainer",""],[1,"cesium-shell"],[1,"cesium-top"],["type","button",1,"cesium-back",3,"click"],[1,"cesium-title"],[1,"cesium-sub"],[1,"cesium-container"]],template:function(i,e){if(i&1){let o=x();p(0,"div",1)(1,"div",2)(2,"button",3),_("click",function(){return v(o),P(e.goBack())}),g(3,"Back"),m(),p(4,"div",4),g(5,"Cesium Prototype"),m(),p(6,"div",5),g(7,"3D globe + boundaries + live dots"),m()(),f(8,"div",6,0),m(),f(10,"app-bottom-tabs")}},dependencies:[I,B],styles:["[_nghost-%COMP%]{display:block;height:100%}.cesium-shell[_ngcontent-%COMP%]{position:relative;min-height:100vh;background:radial-gradient(circle at 30% 15%,#124a62bf,#0b2a3b 55%,#071924);overflow:hidden;padding-bottom:var(--tabs-safe, 64px);box-sizing:border-box}.cesium-top[_ngcontent-%COMP%]{position:absolute;top:16px;left:16px;z-index:5;display:flex;align-items:center;gap:12px;color:#eaf3ff;background:#060e1899;border:1px solid rgba(92,160,210,.2);padding:10px 14px;border-radius:16px;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);flex-wrap:wrap}.cesium-back[_ngcontent-%COMP%]{border:0;background:#1c6aa2;color:#fff;padding:6px 12px;border-radius:12px;cursor:pointer;font-weight:600}.cesium-title[_ngcontent-%COMP%]{font-weight:700;letter-spacing:.02em}.cesium-sub[_ngcontent-%COMP%]{font-size:12px;opacity:.8}.cesium-container[_ngcontent-%COMP%]{position:absolute;inset:0}.cesium-shell[_ngcontent-%COMP%]   .cesium-credit-compact[_ngcontent-%COMP%]{right:12px!important;top:12px!important;bottom:auto!important;background:#040c148c;border-radius:10px;padding:4px 8px;font-size:10px!important;opacity:.8}.cesium-shell[_ngcontent-%COMP%]   .cesium-credit-compact[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{height:12px!important}.cesium-shell[_ngcontent-%COMP%]   .cesium-credit-compact[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:#cfe6ff!important;text-decoration:none!important}"]})};export{D as GlobeCesiumPageComponent};
