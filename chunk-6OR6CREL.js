import{a as pe}from"./chunk-HLICNTJQ.js";import{a as he}from"./chunk-S7D4WX2P.js";import{a as me}from"./chunk-ZQ76HOHQ.js";import{a as ce}from"./chunk-TS4QU3HE.js";import{a as le}from"./chunk-JFWLUDT4.js";import{a as ee,b as te,c as ie,d as ne,e as ae,f as se,n as oe,o as re}from"./chunk-KSNNJYBO.js";import{b as ge}from"./chunk-YRPTNGKR.js";import{a as de}from"./chunk-YQ2TA2FF.js";import"./chunk-7DJA5TI4.js";import{a as R}from"./chunk-LQQHCQP3.js";import{c as J}from"./chunk-KO5X6LCN.js";import{$ as q,B as K,C as I,D as o,Da as G,G as w,Ga as X,H,Ia as Z,L as v,O as U,P as g,Q as r,R as c,S as C,V,W as A,Y as y,Z as _,_ as l,aa as T,ba as O,ca as D,ea as S,fa as p,ga as b,ha as M,ja as N,ka as F,la as B,p as u,q as f,sa as z,ua as W,v as j,xa as Y,ya as Q}from"./chunk-SPQ2JWKS.js";import{a as L,b as $}from"./chunk-2NFLSA4Y.js";var _e=["mediaInput"],ve=["messageInput"],xe=["messageList"],Ce=["remoteVideo"],ye=["localVideo"];function be(s,t){s&1&&(r(0,"div",20),p(1,"Loading conversations..."),c())}function Me(s,t){if(s&1&&(r(0,"div",21),p(1),c()),s&2){let e=l();o(),b(e.conversationError)}}function we(s,t){s&1&&(r(0,"div",20),p(1," No conversations yet. "),c())}function Ie(s,t){if(s&1&&C(0,"img",31),s&2){let e,i=l().$implicit,n=l();g("src",(e=n.otherMember(i))==null?null:e.avatar_url,I)}}function Pe(s,t){if(s&1&&(r(0,"div",32),p(1),c()),s&2){let e=l().$implicit,i=l();o(),M(" ",i.initialsFor(i.otherMember(e))," ")}}function Se(s,t){s&1&&C(0,"span",33)}function ke(s,t){if(s&1){let e=y();r(0,"button",22),_("click",function(){let n=u(e).$implicit,a=l();return f(a.selectConversation(n,!0))}),r(1,"div",23),v(2,Ie,1,1,"img",24)(3,Pe,2,1,"div",25),c(),r(4,"div",26)(5,"div",27),p(6),c(),r(7,"div",28),p(8),c()(),r(9,"div",29),p(10),c(),v(11,Se,1,0,"span",30),c()}if(s&2){let e,i,n=t.$implicit,a=l();S("active",n.id===a.activeConversationId),o(2),g("ngIf",(e=a.otherMember(n))==null?null:e.avatar_url),o(),g("ngIf",!((i=a.otherMember(n))!=null&&i.avatar_url)),o(3),b(a.displayNameFor(a.otherMember(n))),o(2),b(a.conversationSnippet(n)),o(2),b(a.formatTime(n.last_message_at||n.updated_at)),o(),g("ngIf",a.isConversationUnread(n))}}function Te(s,t){if(s&1){let e=y();r(0,"button",50),_("click",function(){u(e);let n=l(3);return f(n.showConversationList())}),p(1," Chats "),c()}}function Oe(s,t){if(s&1&&C(0,"img",31),s&2){let e,i=l(3);g("src",(e=i.otherMember(i.activeConversation))==null?null:e.avatar_url,I)}}function Ee(s,t){if(s&1&&(r(0,"div",32),p(1),c()),s&2){let e=l(3);o(),M(" ",e.initialsFor(e.otherMember(e.activeConversation))," ")}}function Le(s,t){if(s&1&&(r(0,"div",51),p(1),c()),s&2){let e=t.ngIf;o(),M(" ",e," ")}}function Ve(s,t){if(s&1){let e=y();r(0,"div",38),v(1,Te,2,0,"button",39),r(2,"div",40),v(3,Oe,1,1,"img",24)(4,Ee,2,1,"div",25),c(),r(5,"div",41)(6,"div",42),p(7),c(),v(8,Le,2,1,"div",43),c(),r(9,"div",44)(10,"button",45),_("click",function(){u(e);let n=l(2);return f(n.goBack())}),p(11,"Back"),c(),r(12,"button",46),_("click",function(){u(e);let n=l(2);return f(n.startCall("audio"))}),C(13,"img",47),c(),r(14,"button",48),_("click",function(){u(e);let n=l(2);return f(n.startCall("video"))}),C(15,"img",49),c()()()}if(s&2){let e,i,n=l(2);o(),g("ngIf",n.mobileThreadOnly),o(2),g("ngIf",(e=n.otherMember(n.activeConversation))==null?null:e.avatar_url),o(),g("ngIf",!((i=n.otherMember(n.activeConversation))!=null&&i.avatar_url)),o(3),b(n.displayNameFor(n.otherMember(n.activeConversation))),o(),g("ngIf",n.displayHandleFor(n.otherMember(n.activeConversation))),o(4),g("disabled",!n.canStartCall()),o(2),g("disabled",!n.canStartCall())}}function Ae(s,t){s&1&&(r(0,"div",52),p(1,"Select a conversation to start chatting."),c())}function Re(s,t){s&1&&(r(0,"div",20),p(1,"Loading messages..."),c())}function Ue(s,t){if(s&1&&(r(0,"div",21),p(1),c()),s&2){let e=l(3);o(),b(e.messageError)}}function De(s,t){if(s&1&&(r(0,"div",75),p(1),c()),s&2){let e=l(2).$implicit,i=l(4);o(),M(" ",i.formatDayLabel(e.created_at)," ")}}function Ne(s,t){if(s&1&&C(0,"img",31),s&2){let e=l(2).$implicit,i=l(4);g("src",i.senderAvatarUrl(e),I)}}function Fe(s,t){if(s&1&&(r(0,"div",32),p(1),c()),s&2){let e=l(2).$implicit,i=l(4);o(),M(" ",i.initialsFor(i.senderInfo(e))," ")}}function Be(s,t){if(s&1){let e=y();r(0,"div",76),_("click",function(){let n=u(e).ngIf,a=l(6);return f(a.scrollToMessage(n.id))}),r(1,"div",77),p(2),c(),r(3,"div",78),p(4),c()()}if(s&2){let e=t.ngIf;o(2),M("Replying to ",e.name),o(2),b(e.text)}}function ze(s,t){if(s&1&&(r(0,"div",79),p(1),c()),s&2){let e=t.ngIf,i=l(2).$implicit,n=l(4);S("call-log",n.isCallLogMessage(i)),o(),M(" ",e," ")}}function $e(s,t){if(s&1){let e=y();r(0,"img",84),_("click",function(){u(e);let n=l(3).$implicit,a=l(4);return f(a.openImageLightbox(n.media_url))}),c()}if(s&2){let e=l(3).$implicit;g("src",e.media_url,I)}}function je(s,t){if(s&1&&C(0,"app-video-player",85),s&2){let e=l(3).$implicit;g("src",e.media_url)}}function Ke(s,t){if(s&1&&(r(0,"div",80),v(1,$e,1,1,"img",81)(2,je,1,1,"app-video-player",82),r(3,"a",83),p(4," Download "),c()()),s&2){let e=l(2).$implicit;o(),g("ngIf",e.media_type==="image"),o(),g("ngIf",e.media_type==="video"),o(),g("href",e.media_url,I),U("download",e.media_name||"message-media")}}function He(s,t){s&1&&(r(0,"span",86),p(1,"edited"),c())}function qe(s,t){if(s&1&&C(0,"span",87),s&2){let e=t.ngIf,i=l(6);S("read",e==="read"),g("innerHTML",i.statusGlyph(e),K)}}function We(s,t){if(s&1){let e=y();r(0,"div",88)(1,"button",89),_("click",function(){u(e);let n=l(2).$implicit,a=l(4);return f(a.startEditMessage(n))}),p(2,"Edit"),c(),r(3,"button",90),_("click",function(){u(e);let n=l(2).$implicit,a=l(4);return f(a.deleteMessage(n))}),p(4,"Delete"),c()()}}function Ye(s,t){if(s&1){let e=y();r(0,"div",91)(1,"textarea",92),B("ngModelChange",function(n){u(e);let a=l(6);return F(a.editingDraft,n)||(a.editingDraft=n),f(n)}),c(),r(2,"div",93)(3,"button",94),_("click",function(){u(e);let n=l(6);return f(n.cancelEditMessage())}),p(4,"Cancel"),c(),r(5,"button",95),_("click",function(){u(e);let n=l(2).$implicit,a=l(4);return f(a.saveEditMessage(n))}),p(6),c()()()}if(s&2){let e=l(6);o(),N("ngModel",e.editingDraft),o(4),g("disabled",e.editBusy),o(),M(" ",e.editBusy?"Saving...":"Save"," ")}}function Qe(s,t){if(s&1){let e=y();V(0),v(1,De,2,1,"div",57),r(2,"div",58)(3,"div",59),v(4,Ne,1,1,"img",24)(5,Fe,2,1,"div",25),c(),r(6,"div",60),v(7,Be,5,2,"div",61)(8,ze,2,3,"div",62)(9,Ke,5,4,"div",63),r(10,"div",64)(11,"span",65),p(12),r(13,"span",66),p(14),c()(),v(15,He,2,0,"span",67)(16,qe,1,3,"span",68),c(),r(17,"div",69)(18,"button",70),_("click",function(){u(e);let n=l().$implicit,a=l(4);return f(a.startReply(n))}),p(19,"\u21A9 Reply"),c(),r(20,"button",71),_("click",function(){u(e);let n=l().$implicit,a=l(4);return f(a.toggleMessageLike(n))}),r(21,"span",72),p(22),c(),p(23),c()(),v(24,We,5,0,"div",73)(25,Ye,7,3,"div",74),c()(),A()}if(s&2){let e=l(),i=e.$implicit,n=e.index,a=l(4);o(),g("ngIf",a.showDaySeparatorVisible(n)),o(),S("me",i.sender_id===a.meId)("call-log",a.isCallLogMessage(i)),U("id","msg-"+i.id),o(2),g("ngIf",a.senderAvatarUrl(i)),o(),g("ngIf",!a.senderAvatarUrl(i)),o(2),g("ngIf",a.replyPreview(i)),o(),g("ngIf",a.messageText(i)),o(),g("ngIf",i.media_type&&i.media_url),o(3),M(" ",a.formatTimestamp(i.created_at)," "),o(2),b(a.formatDayLabel(i.created_at)),o(),g("ngIf",a.isEdited(i)),o(),g("ngIf",a.messageStatus(i)),o(4),S("active",a.isMessageLikedByMe(i)),o(2),b(a.isMessageLikedByMe(i)?"\u2764":"\u2661"),o(),M(" ",a.messageLikeCount(i)),o(),g("ngIf",i.sender_id===a.meId&&!a.isEditing(i)&&!a.isCallLogMessage(i)),o(),g("ngIf",a.isEditing(i))}}function Ge(s,t){if(s&1&&(V(0),v(1,Qe,26,21,"ng-container",17),A()),s&2){let e=t.$implicit,i=l(4);o(),g("ngIf",!i.isReactionMessage(e))}}function Xe(s,t){if(s&1&&(r(0,"div",55,1),v(2,Ge,2,1,"ng-container",56),c()),s&2){let e=l(3);o(2),g("ngForOf",e.messages)("ngForTrackBy",e.trackMessageById)}}function Ze(s,t){if(s&1&&(r(0,"div",53),v(1,Re,2,0,"div",13)(2,Ue,2,1,"div",14)(3,Xe,3,2,"div",54),c()),s&2){let e=l(2);o(),g("ngIf",e.loadingMessages),o(),g("ngIf",e.messageError),o(),g("ngIf",!e.loadingMessages)}}function Je(s,t){if(s&1){let e=y();r(0,"div",105)(1,"div"),p(2," Replying to "),r(3,"strong"),p(4),c()(),r(5,"div",106),p(6),c(),r(7,"button",107),_("click",function(){u(e);let n=l(3);return f(n.cancelReply())}),p(8,"\xD7"),c()()}if(s&2){let e=l(3);o(4),b(e.displayNameFor(e.senderInfo(e.replyingTo))),o(2),b(e.replySnippet(e.replyingTo))}}function et(s,t){if(s&1&&C(0,"img",112),s&2){let e=l(4);g("src",e.messageMediaPreview,I)}}function tt(s,t){if(s&1&&C(0,"video",113),s&2){let e=l(4);g("src",e.messageMediaPreview,I)}}function it(s,t){if(s&1){let e=y();r(0,"div",108),v(1,et,1,1,"img",109)(2,tt,1,1,"video",110),r(3,"button",111),_("click",function(){u(e);let n=l(3);return f(n.clearMedia())}),p(4,"Remove"),c()()}if(s&2){let e=l(3);o(),g("ngIf",e.messageMediaType==="image"),o(),g("ngIf",e.messageMediaType==="video")}}function nt(s,t){if(s&1&&(r(0,"div",21),p(1),c()),s&2){let e=l(3);o(),b(e.messageMediaError)}}function at(s,t){if(s&1){let e=y();r(0,"form",96),_("ngSubmit",function(){u(e);let n=l(2);return f(n.sendMessage())}),v(1,Je,9,2,"div",97),r(2,"div",98)(3,"input",99,2),_("change",function(n){u(e);let a=l(2);return f(a.onMediaSelected(n))}),c(),r(5,"div",100)(6,"button",101),_("click",function(){u(e);let n=l(2);return f(n.triggerMediaPicker())}),p(7," + "),c(),r(8,"textarea",102,3),B("ngModelChange",function(n){u(e);let a=l(2);return F(a.messageDraft,n)||(a.messageDraft=n),f(n)}),_("input",function(n){u(e);let a=l(2);return f(a.onMessageInput(n))}),c(),v(10,it,5,2,"div",103),c(),r(11,"button",104),p(12),c()(),v(13,nt,2,1,"div",14),c()}if(s&2){let e=l(2);o(),g("ngIf",e.replyingTo),o(7),N("ngModel",e.messageDraft),o(2),g("ngIf",e.messageMediaPreview),o(),g("disabled",e.messageBusy||!e.canSendMessage()),o(),M(" ",e.messageBusy?"Sending...":"Send"," "),o(),g("ngIf",e.messageMediaError)}}function st(s,t){if(s&1&&(r(0,"section",34),v(1,Ve,16,7,"div",35)(2,Ae,2,0,"ng-template",null,0,z)(4,Ze,4,3,"div",36)(5,at,14,6,"form",37),c()),s&2){let e=D(3),i=l();o(),g("ngIf",i.activeConversation)("ngIfElse",e),o(3),g("ngIf",i.activeConversation),o(),g("ngIf",i.activeConversation)}}function ot(s,t){s&1&&C(0,"app-bottom-tabs")}function rt(s,t){if(s&1){let e=y();r(0,"div",114),_("click",function(){u(e);let n=l();return f(n.closeImageLightbox())}),r(1,"div",115),_("click",function(n){return u(e),f(n.stopPropagation())}),r(2,"div",116)(3,"button",117),_("click",function(){u(e);let n=l();return f(n.closeImageLightbox())}),p(4,"x"),c(),C(5,"img",118),c()()()}if(s&2){let e=l();o(5),g("src",e.lightboxUrl,I)}}function lt(s,t){s&1&&C(0,"video",132,5)}function ct(s,t){if(s&1&&C(0,"img",31),s&2){let e=l(3);g("src",e.callPeerAvatar(),I)}}function dt(s,t){if(s&1&&(r(0,"div",32),p(1),c()),s&2){let e=l(3);o(),M(" ",e.initialsFor(e.callPeer())," ")}}function gt(s,t){if(s&1&&(r(0,"div",133),v(1,ct,1,1,"img",24)(2,dt,2,1,"div",25),c()),s&2){let e=l(2);S("speaking",e.callSpeaking),o(),g("ngIf",e.callPeerAvatar()),o(),g("ngIf",!e.callPeerAvatar())}}function mt(s,t){s&1&&C(0,"video",134,6)}function pt(s,t){if(s&1){let e=y();V(0),r(1,"button",135),_("click",function(){u(e);let n=l(2);return f(n.acceptCall())}),p(2,"Accept"),c(),r(3,"button",136),_("click",function(){u(e);let n=l(2);return f(n.declineCall())}),p(4,"Decline"),c(),A()}}function ht(s,t){if(s&1){let e=y();r(0,"button",137),_("click",function(){u(e);let n=l(3);return f(n.toggleCamera())}),p(1),c()}if(s&2){let e=l(3);o(),M(" ",e.callCameraOff?"Camera on":"Camera off"," ")}}function ut(s,t){if(s&1){let e=y();r(0,"button",137),_("click",function(){u(e);let n=l(2);return f(n.toggleMute())}),p(1),c(),v(2,ht,2,1,"button",138),r(3,"button",136),_("click",function(){u(e);let n=l(2);return f(n.endCall())}),p(4,"End"),c()}if(s&2){let e=l(2);o(),M(" ",e.callMuted?"Unmute":"Mute"," "),o(),g("ngIf",e.callType==="video")}}function ft(s,t){if(s&1){let e=y();r(0,"div",119)(1,"div",120),_("click",function(n){return u(e),f(n.stopPropagation())}),r(2,"div",121),C(3,"img",122),r(4,"div")(5,"div",123),p(6),c(),r(7,"div",124),p(8),c()(),r(9,"div",125),p(10),c()(),r(11,"div",126),v(12,lt,2,0,"video",127)(13,gt,3,4,"div",128)(14,mt,2,0,"video",129),c(),r(15,"div",130),v(16,pt,5,0,"ng-container",131)(17,ut,5,2,"ng-template",null,4,z),c()()()}if(s&2){let e=D(18),i=l();o(),S("video",i.callType==="video"),o(5),b(i.callTitle()),o(2),b(i.callStatusText()),o(2),b(i.callTimerLabel()),o(2),g("ngIf",i.callType==="video"),o(),g("ngIf",i.callType!=="video"),o(),g("ngIf",i.callType==="video"),o(2),g("ngIf",i.callIncoming)("ngIfElse",e)}}var ue=class s{constructor(t,e,i,n,a,d,m,h,x,E){this.route=t;this.router=e;this.auth=i;this.messagesService=n;this.mediaService=a;this.notificationsService=d;this.push=m;this.callService=h;this.zone=x;this.cdr=E}mediaInput;messageInput;messageList;remoteVideo;localVideo;conversations=[];messages=[];activeConversation=null;activeConversationId=null;loadingConversations=!1;loadingMessages=!1;conversationError="";messageError="";messageDraft="";messageBusy=!1;messageMediaFile=null;messageMediaPreview="";messageMediaType=null;messageMediaError="";replyingTo=null;lightboxUrl=null;meId=null;editingMessageId=null;editingDraft="";editBusy=!1;pendingConversation=null;routeSub;pendingSub;callSignalSub;callConnectedSub;pollTimer=null;mobileThreadOnly=!1;isNarrow=!1;unreadConversationIds=new Set;messageNotifications=[];callActive=!1;callConnecting=!1;callIncoming=!1;callType=null;callConversationId=null;callMuted=!1;callCameraOff=!1;callError="";callFromId=null;incomingOffer=null;wsConnected=!1;localStream;remoteStream;livekitRoom;livekitLocalTracks=[];livekitLoadPromise=null;livekitModule=null;pendingCallType=null;pendingCallFrom=null;pendingCallConversationId=null;awaitingOffer=!1;callSessionId=null;callRoomName=null;callLogPrefix="__call__|";audioContext;audioAnalyser;audioData;speakingRafId=null;callSpeaking=!1;callTimerSeconds=0;callTimerId=null;callDisconnectTimer=null;callStartAt=null;callLogSent=!1;destroyed=!1;REACTION_PREFIX="__react__|";REPLY_PREFIX="__reply__|";reactionsByMessage=new Map;async ngOnInit(){this.updateViewportFlag(),this.push.syncIfGranted();let t=await this.auth.getUser();this.meId=t?.id??null,this.forceUi(),this.wsConnected=this.callService.connected,this.callSignalSub=this.callService.signals$.subscribe(a=>{this.handleSignalMessage(a)}),this.callConnectedSub=this.callService.connected$.subscribe(a=>{this.wsConnected=a,this.forceUi()});let e=this.messagesService.getPendingConversation(),i=this.router.getCurrentNavigation()?.extras.state??history.state,n=e??i?.convo??null;n&&(this.pendingConversation=n,this.activeConversation=n,this.activeConversationId=n.id,this.upsertConversation(n),this.enterThreadView(),this.forceUi(),this.loadMessages(n.id,!1)),this.routeSub=this.route.queryParamMap.subscribe(a=>{let d=a.get("c"),m=a.get("call"),h=a.get("from");if(d&&m&&(this.pendingCallType=m==="video"?"video":"audio",this.pendingCallFrom=h,this.pendingCallConversationId=d),!!d){if(d!==this.activeConversationId){this.activateConversationById(d);return}this.messages.length||this.loadMessages(d,!1),this.maybeShowCallFromParams()}}),this.pendingSub=this.messagesService.pendingConversation$.subscribe(a=>{a&&(this.pendingConversation=a,this.activeConversation=a,this.activeConversationId=a.id,this.upsertConversation(a),this.enterThreadView(),this.forceUi(),this.loadMessages(a.id,!1))}),await this.loadConversations(),await this.refreshUnreadConversations(),this.startPolling()}ngOnDestroy(){this.destroyed=!0,this.routeSub?.unsubscribe(),this.pendingSub?.unsubscribe(),this.callSignalSub?.unsubscribe(),this.callConnectedSub?.unsubscribe(),this.pollTimer&&(window.clearInterval(this.pollTimer),this.pollTimer=null),this.cleanupCall(),this.clearMedia()}async loadConversations(t){this.loadingConversations=!0,this.conversationError="",this.forceUi();try{let e=await this.messagesService.listConversations(),i=this.pendingConversation,n=!!i&&e.some(h=>h.id===i.id),a=[...e],d=new Set(a.map(h=>h.id));i&&!d.has(i.id)&&(a.unshift(i),d.add(i.id)),this.activeConversation&&!d.has(this.activeConversation.id)&&(a.unshift(this.activeConversation),d.add(this.activeConversation.id)),this.conversations=a,n&&(this.pendingConversation=null,this.messagesService.clearPendingConversation());let m=t??this.activeConversationId;if(m){let h=this.conversations.find(x=>x.id===m)??null;if(h)this.activeConversation=h,this.activeConversationId=h.id;else if(this.pendingConversation?.id===m)this.activeConversation=this.pendingConversation,this.activeConversationId=m;else{let x=await this.fetchConversationById(m);x&&(this.upsertConversation(x),this.activeConversation=x,this.activeConversationId=x.id,h=x)}}this.activeConversationId&&(!this.messages.length||this.messages[0]?.conversation_id!==this.activeConversationId)&&this.loadMessages(this.activeConversationId,!0)}catch(e){this.conversationError=e?.message??String(e)}finally{this.loadingConversations=!1,this.forceUi()}}startPolling(){this.pollTimer||(this.pollTimer=window.setInterval(()=>{this.loadConversations(),this.refreshUnreadConversations(),this.activeConversationId&&this.loadMessages(this.activeConversationId,!0)},6e3))}get callUiOpen(){return this.callActive||this.callConnecting||this.callIncoming||!!this.callError}canStartCall(){return!!(this.activeConversationId&&this.wsConnected&&!this.callActive&&!this.callConnecting&&!this.callIncoming)}callPeer(){return this.activeConversation?this.callFromId?this.activeConversation.members.find(t=>t.user_id===this.callFromId)??this.otherMember(this.activeConversation):this.otherMember(this.activeConversation):null}callPeerAvatar(){return this.callPeer()?.avatar_url??""}callTitle(){let t=this.callPeer(),e=t?this.displayNameFor(t):"Member";return`${this.callType==="video"?"Video call":"Voice call"} \xB7 ${e}`}callStatusText(){return this.callError?this.callError:this.callIncoming?this.incomingOffer?"Incoming call":"Tap accept to call back":this.callConnecting?"Connecting...":this.callActive?"In call":""}callTimerLabel(){return this.callStartAt?this.formatDuration(this.callTimerSeconds):"00:00"}markCallActive(){this.callStartAt||(this.callStartAt=Date.now()),this.startCallTimer()}getCallLogMeta(){return{conversationId:this.callConversationId,kind:this.callType,startedAt:this.callStartAt}}maybeShowCallFromParams(){!this.pendingCallType||!this.pendingCallConversationId||this.pendingCallConversationId===this.activeConversationId&&(this.callActive||this.callConnecting||this.callIncoming||(this.callType=this.pendingCallType,this.callConversationId=this.pendingCallConversationId,this.callFromId=this.pendingCallFrom,this.callIncoming=!0,this.callConnecting=!1,this.callActive=!1,this.callError="",this.pendingCallType=null,this.pendingCallFrom=null,this.pendingCallConversationId=null,this.clearCallParams(),this.forceUi()))}clearCallParams(){this.router.navigate([],{relativeTo:this.route,queryParams:{call:null,from:null},queryParamsHandling:"merge"})}newCallSessionId(){try{return crypto.randomUUID()}catch{return`${Date.now()}-${Math.random().toString(16).slice(2)}`}}async startCall(t){if(!(!this.activeConversationId||!this.canStartCall())){(this.callActive||this.callConnecting||this.callIncoming)&&this.cleanupCall(),this.callType=t,this.callConversationId=this.activeConversationId,this.callSessionId=this.newCallSessionId(),this.callRoomName=`call_${this.callConversationId}_${this.callSessionId}`,this.callConnecting=!0,this.callIncoming=!1,this.callActive=!1,this.callFromId=this.meId,this.callError="",this.callStartAt=null,this.callLogSent=!1,this.forceUi();try{await this.ensureLiveKitConnected(t,this.callRoomName),this.sendSignal("call-offer",this.callConversationId,{callType:t,roomName:this.callRoomName})}catch(e){this.callError=e?.message??"Call failed.",this.callConnecting=!1,this.callActive=!1,this.forceUi()}}}async acceptCall(){if(!this.incomingOffer){let e=this.callType??"audio";this.callConversationId&&this.activeConversationId!==this.callConversationId&&await this.activateConversationById(this.callConversationId),this.callConversationId&&(this.callConnecting=!0,this.callIncoming=!1,this.callActive=!1,this.callError="",this.callSessionId=null,this.awaitingOffer=!0,this.sendSignal("call-accept",this.callConversationId,{callType:e,to:this.callFromId})),this.callService.clearIncomingCall(),this.forceUi();return}let t=this.incomingOffer;this.callConversationId=t.conversationId,this.callType=t.callType,this.callFromId=t.from,this.callSessionId=t.callId??this.callSessionId,this.callIncoming=!1,this.callConnecting=!0,this.callActive=!1,this.callError="",this.callService.clearIncomingCall(),this.callStartAt=null,this.callLogSent=!1,this.awaitingOffer=!1,this.forceUi();try{let e=t.roomName??(t.callId?`call_${t.conversationId}_${t.callId}`:null);if(this.callRoomName=e,!e)throw new Error("Missing call room.");await this.ensureLiveKitConnected(t.callType,e),this.sendSignal("call-accept",t.conversationId,{callType:t.callType,roomName:e}),this.incomingOffer=null}catch(e){this.callError=e?.message??"Call failed.",this.callConnecting=!1,this.callActive=!1,this.forceUi()}}declineCall(){this.incomingOffer&&(this.sendSignal("call-decline",this.incomingOffer.conversationId),this.callService.clearIncomingCall(),this.cleanupCall())}toggleMute(){let t=!this.callMuted;this.livekitRoom?this.livekitRoom.localParticipant.setMicrophoneEnabled(!t):this.localStream&&this.localStream.getAudioTracks().forEach(e=>{e.enabled=!t}),this.callMuted=t,this.forceUi()}toggleCamera(){let t=!this.callCameraOff;this.livekitRoom?this.livekitRoom.localParticipant.setCameraEnabled(!t):this.localStream&&this.localStream.getVideoTracks().forEach(e=>{e.enabled=!t}),this.callCameraOff=t,this.forceUi()}endCall(){let t=this.getCallLogMeta(),e=this.callActive||this.callStartAt?"ended":"missed";this.sendCallLog(e,t),this.cleanupCall(!0,!0)}async sendCallLog(t,e){if(this.callLogSent)return;let i=e.conversationId;if(!i)return;let n=e.kind==="video"?"video":"audio",a=e.startedAt?Math.round((Date.now()-e.startedAt)/1e3):0,d=this.buildCallLogBody(t,n,a);try{let m=await this.messagesService.sendMessage(i,d);m&&(this.messages=[...this.messages,m],this.bumpConversation(m),this.scrollToBottom(),this.forceUi())}catch{}this.callLogSent=!0}sendSignal(t,e,i){this.callService.sendSignal(t,e,L(L({from:this.meId},this.callSessionId?{callId:this.callSessionId}:{}),i??{}))}async handleSignalMessage(t){let e=String(t?.type??""),i=String(t?.conversationId??""),n=String(t?.from??""),a=typeof t?.callId=="string"?String(t.callId):"",d=this.callSessionId?a===this.callSessionId:!0;if(!(!e||!i||!n||n===this.meId)){if(e==="call-offer"){let m=this.awaitingOffer&&i===this.callConversationId;if(!m&&(this.callActive||this.callIncoming||this.callConnecting&&this.callFromId&&this.callFromId!==n)){this.sendSignal("call-busy",i,{callId:a});return}!m&&this.callConnecting&&this.callFromId===this.meId&&this.cleanupCall(!1);let h=t.callType==="video"?"video":"audio",x=a||null;x&&(this.callSessionId=x);let E=typeof t?.roomName=="string"?String(t.roomName):null;if(this.incomingOffer={conversationId:i,from:n,callType:h,callId:x,roomName:E},this.awaitingOffer=!1,this.callConnecting&&(this.callFromId===n||m)){this.callIncoming=!1,await this.acceptCall();return}this.callConversationId=i,this.callType=h,this.callFromId=n,this.callIncoming=!0,this.callConnecting=!1,this.callActive=!1,this.callStartAt=null,this.callLogSent=!1,this.callService.clearIncomingCall(),this.forceUi(),i!==this.activeConversationId&&await this.activateConversationById(i);return}if(e==="call-accept"){if(this.callFromId!==this.meId||!this.callConversationId||i!==this.callConversationId)return;try{let m=t.callType==="video"?"video":this.callType??"audio";this.callType=m;let h=typeof t?.roomName=="string"?String(t.roomName):this.callRoomName;if(!h)return;this.callRoomName=h,await this.ensureLiveKitConnected(m,h)}catch{}return}if(i===this.callConversationId){if(e==="call-decline"||e==="call-busy"){if(!d)return;this.callFromId===this.meId&&this.sendCallLog("missed",this.getCallLogMeta()),this.cleanupCall();return}if(e==="call-end"){if(!d)return;this.cleanupCall()}}}}async ensureLiveKitConnected(t,e){if(this.livekitRoom&&this.livekitRoom.name===e)return;await this.disconnectLiveKit(),this.callMuted=!1,this.callCameraOff=t!=="video";let i=await this.fetchLiveKitToken(e),n=i.url||R.livekitUrl;if(!n)throw new Error("LiveKit URL not configured.");await this.ensureLiveKitLoaded();let a=this.livekitModule||window.LiveKit;if(!a)throw new Error("LiveKit not loaded.");let{Room:d,RoomEvent:m,createLocalTracks:h}=a,x=new d({adaptiveStream:!0,dynacast:!0});this.livekitRoom=x,this.remoteStream=new MediaStream,x.on(m.TrackSubscribed,k=>{let P=k?.mediaStreamTrack;P&&(this.remoteStream||(this.remoteStream=new MediaStream),this.remoteStream.getTracks().some(fe=>fe.id===P.id)||this.remoteStream.addTrack(P),this.attachRemoteStream(),this.callActive||(this.callActive=!0,this.callConnecting=!1,this.markCallActive(),this.clearDisconnectTimer(),this.forceUi()))}),x.on(m.TrackUnsubscribed,k=>{let P=k?.mediaStreamTrack;!P||!this.remoteStream||this.remoteStream.removeTrack(P)}),x.on(m.ParticipantConnected,()=>{this.callActive||(this.callActive=!0,this.callConnecting=!1,this.markCallActive(),this.clearDisconnectTimer(),this.forceUi())}),x.on(m.ParticipantDisconnected,()=>{this.callActive&&this.startDisconnectTimer()}),x.on(m.Disconnected,()=>{this.destroyed||(this.callError=this.callError||"Call disconnected.",this.cleanupCall(!1),this.forceUi())}),await x.connect(n,i.token),this.callConnecting=!0,this.callError="";let E=await h({audio:!0,video:t==="video"});this.livekitLocalTracks=E,this.localStream=new MediaStream;for(let k of E){let P=k?.mediaStreamTrack;P&&this.localStream.addTrack(P),await x.localParticipant.publishTrack(k)}this.startVoiceDetection(),this.forceUi(),requestAnimationFrame(()=>{this.attachLocalStream()})}async fetchLiveKitToken(t){let e=await this.auth.getAccessToken();if(!e)throw new Error("Missing auth token.");let i=await fetch(`${R.apiBaseUrl}/livekit/token`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({room:t,name:this.meId??"member"})}),n=await i.json().catch(()=>({}));if(!i.ok){let m=typeof n?.error=="string"?n.error:"LiveKit auth failed.";throw new Error(m)}let a=typeof n?.url=="string"?n.url:R.livekitUrl,d=typeof n?.token=="string"?n.token:"";if(!d)throw new Error("Missing LiveKit token.");return{token:d,url:a??""}}async disconnectLiveKit(){if(this.livekitRoom){try{this.livekitRoom.removeAllListeners(),this.livekitRoom.disconnect()}catch{}this.livekitRoom=void 0}if(this.livekitLocalTracks.length){for(let t of this.livekitLocalTracks)try{t.stop()}catch{}this.livekitLocalTracks=[]}}attachLocalStream(){if(!this.localStream||this.callType!=="video")return;let t=this.localVideo?.nativeElement;t&&(t.srcObject=this.localStream,t.play().catch(()=>{}))}remoteAudio;attachRemoteStream(){if(this.remoteStream){if(this.callType==="video"){let t=this.remoteVideo?.nativeElement;if(!t)return;t.srcObject=this.remoteStream,t.play().catch(()=>{});return}this.remoteAudio||(this.remoteAudio=new Audio,this.remoteAudio.autoplay=!0),this.remoteAudio.srcObject=this.remoteStream,this.remoteAudio.play().catch(()=>{})}}cleanupCall(t=!0,e=!1){e&&this.callConversationId&&this.sendSignal("call-end",this.callConversationId),t&&(this.callError=""),this.callActive=!1,this.callConnecting=!1,this.callIncoming=!1,this.callType=null,this.callConversationId=null,this.callMuted=!1,this.callCameraOff=!1,this.callFromId=null,this.incomingOffer=null,this.callStartAt=null,this.callLogSent=!1,this.callSpeaking=!1,this.callTimerSeconds=0,this.awaitingOffer=!1,this.callSessionId=null,this.callRoomName=null,this.stopCallTimer(),this.clearDisconnectTimer(),this.stopVoiceDetection(),this.disconnectLiveKit(),this.localStream&&(this.localStream.getTracks().forEach(i=>i.stop()),this.localStream=void 0),this.remoteStream&&(this.remoteStream.getTracks().forEach(i=>i.stop()),this.remoteStream=void 0),this.localVideo?.nativeElement&&(this.localVideo.nativeElement.srcObject=null),this.remoteVideo?.nativeElement&&(this.remoteVideo.nativeElement.srcObject=null),this.remoteAudio&&(this.remoteAudio.srcObject=null),this.forceUi()}startCallTimer(){this.callTimerId||(this.callTimerId=window.setInterval(()=>{this.callStartAt?this.callTimerSeconds=Math.max(0,Math.floor((Date.now()-this.callStartAt)/1e3)):this.callTimerSeconds=0,this.forceUi()},1e3))}stopCallTimer(){this.callTimerId&&(window.clearInterval(this.callTimerId),this.callTimerId=null)}startDisconnectTimer(){this.callDisconnectTimer||(this.callDisconnectTimer=window.setTimeout(()=>{this.callActive?(this.callConversationId&&this.sendSignal("call-end",this.callConversationId),this.cleanupCall()):this.callConnecting&&this.cleanupCall()},8e3))}clearDisconnectTimer(){this.callDisconnectTimer&&(window.clearTimeout(this.callDisconnectTimer),this.callDisconnectTimer=null)}startVoiceDetection(){if(!this.localStream||this.audioContext)return;let t=window.AudioContext||window.webkitAudioContext;if(t)try{this.audioContext=new t;let e=this.audioContext;if(!e)return;let i=e.createMediaStreamSource(this.localStream);this.audioAnalyser=e.createAnalyser(),this.audioAnalyser.fftSize=512,i.connect(this.audioAnalyser),this.audioData=new Uint8Array(this.audioAnalyser.fftSize),e.resume().catch(()=>{});let n=()=>{if(!this.audioAnalyser||!this.audioData)return;this.audioAnalyser.getByteTimeDomainData(this.audioData);let a=0;for(let h=0;h<this.audioData.length;h+=1){let x=(this.audioData[h]-128)/128;a+=x*x}let m=Math.sqrt(a/this.audioData.length)>.03;m!==this.callSpeaking&&(this.callSpeaking=m,this.forceUi()),this.speakingRafId=requestAnimationFrame(n)};n()}catch{this.stopVoiceDetection()}}stopVoiceDetection(){if(this.speakingRafId&&(cancelAnimationFrame(this.speakingRafId),this.speakingRafId=null),this.audioAnalyser)try{this.audioAnalyser.disconnect()}catch{}this.audioAnalyser=void 0,this.audioData=void 0,this.audioContext&&(this.audioContext.close().catch(()=>{}),this.audioContext=void 0)}async selectConversation(t,e){this.activeConversation=t,this.activeConversationId=t.id,this.enterThreadView(),this.forceUi(),e&&this.router.navigate([],{relativeTo:this.route,queryParams:{c:t.id},queryParamsHandling:"merge"}),await this.loadMessages(t.id,!1),this.maybeShowCallFromParams(),this.scrollToBottom(),window.setTimeout(()=>this.scrollToBottom(),80)}async activateConversationById(t){if(!t)return;this.conversations.length||await this.loadConversations(t);let e=this.conversations.find(n=>n.id===t)??null;if(e){await this.selectConversation(e,!1);return}if(this.pendingConversation?.id===t){this.activeConversation=this.pendingConversation,this.activeConversationId=t,this.enterThreadView(),this.forceUi(),await this.loadMessages(t,!1),this.scrollToBottom(),window.setTimeout(()=>this.scrollToBottom(),80);return}let i=await this.fetchConversationById(t);if(i){this.upsertConversation(i),this.enterThreadView(),this.forceUi(),await this.selectConversation(i,!1);return}this.activeConversationId=t,this.enterThreadView(),this.forceUi(),await this.loadMessages(t,!1),this.scrollToBottom(),window.setTimeout(()=>this.scrollToBottom(),80)}upsertConversation(t){this.conversations.findIndex(i=>i.id===t.id)>=0||(this.conversations=[t,...this.conversations])}async fetchConversationById(t){try{return await this.messagesService.getConversationById(t)}catch{return null}}async loadMessages(t,e){if(!t)return;e||(this.loadingMessages=!0,this.messageError="",this.forceUi());let i=this.messages[this.messages.length-1]?.id??null,n=!1;try{let a=await this.messagesService.listMessages(t,300);e?this.messages=this.mergeMessages(t,this.messages,a,200):this.messages=a,this.rebuildReactions(),n=(this.messages[this.messages.length-1]?.id??null)!==i||!e,e||await this.markConversationNotificationsRead(t)}catch(a){this.messageError=a?.message??String(a)}finally{this.loadingMessages=!1,this.forceUi(),n&&this.scrollToBottom()}}async sendMessage(){if(!this.activeConversationId||this.messageBusy)return;let t=this.messageDraft.trim();if(!(!t&&!this.messageMediaFile)){this.replyingTo&&(t=this.buildReplyBody(this.replyingTo,t)),this.messageBusy=!0,this.messageError="",this.messageMediaError="",this.forceUi();try{let e;if(this.messageMediaFile)try{let n=await this.mediaService.uploadMessageMedia(this.messageMediaFile,this.activeConversationId);e={type:this.messageMediaFile.type.startsWith("video/")?"video":"image",path:n.path,name:n.name,mime:n.mime,size:n.size}}catch(n){this.messageMediaError=n?.message??"Upload failed. Check your bucket policy and file type.",this.messageBusy=!1,this.forceUi();return}let i=await this.messagesService.sendMessage(this.activeConversationId,t,e);this.messages=[...this.messages,i],this.messageDraft="",this.replyingTo=null,this.resetMessageInput(),this.clearMedia(),this.bumpConversation(i),this.scrollToBottom()}catch(e){this.messageError=e?.message??String(e)}finally{this.messageBusy=!1,this.forceUi()}}}canSendMessage(){return!!(this.messageDraft.trim()||this.messageMediaFile)}onMessageInput(t){let e=t?.target??this.messageInput?.nativeElement;if(!e)return;e.style.height="auto";let i=160,a=Math.min(Math.max(e.scrollHeight,32),i);e.style.height=`${a}px`,e.style.overflowY=e.scrollHeight>i?"auto":"hidden"}scrollToBottom(t=0){let e=this.messageList?.nativeElement;if(!e){t<2&&window.setTimeout(()=>this.scrollToBottom(t+1),60);return}let i=()=>{e.scrollTop=e.scrollHeight};requestAnimationFrame(()=>{i(),requestAnimationFrame(i)}),t===0&&window.setTimeout(i,0)}mergeMessages(t,e,i,n){let a=new Map;for(let m of e)!m?.id||m.conversation_id!==t||a.set(m.id,m);for(let m of i)!m?.id||m.conversation_id!==t||a.set(m.id,m);let d=Array.from(a.values());return d.sort((m,h)=>this.messageEpoch(m.created_at)-this.messageEpoch(h.created_at)),d.length>n?d.slice(-n):d}messageEpoch(t){if(!t)return 0;let e=Number(t);if(Number.isFinite(e))return e;let i=Date.parse(t);return Number.isFinite(i)?i:0}trackMessageById(t,e){return e?.id??t}triggerMediaPicker(){this.mediaInput?.nativeElement.click()}onMediaSelected(t){let e=t.target,i=e.files?.[0]??null;if(!i)return;let n=i.type||"",a=["image/png","image/jpeg","image/webp"],d=["video/mp4","video/webm","video/quicktime"];if(!a.includes(n)&&!d.includes(n)){this.messageMediaError="Only PNG/JPG/WebP images or MP4/WebM/MOV videos are supported.",e.value="",this.forceUi();return}this.clearMedia(),this.messageMediaFile=i,this.messageMediaType=n.startsWith("video/")?"video":"image",this.messageMediaPreview=URL.createObjectURL(i),this.messageMediaError="",e.value="",this.forceUi()}clearMedia(){if(this.messageMediaPreview)try{URL.revokeObjectURL(this.messageMediaPreview)}catch{}this.messageMediaFile=null,this.messageMediaType=null,this.messageMediaPreview="",this.messageMediaError=""}openImageLightbox(t){this.lightboxUrl=t,this.forceUi()}closeImageLightbox(){this.lightboxUrl=null,this.forceUi()}messageText(t){let e=String(t?.body??""),i=e.trim();if(!i||this.isReactionMessage(t))return"";let n=this.parseCallLog(i);if(n)return this.formatCallLog(n);let a=this.parseReply(i);if(a){let d=a.body.trim();return d||""}return t?.id&&i===t.id||this.looksLikeId(i)?"":this.stripTrailingMeta(i)!==i?this.stripTrailingMeta(i):e}startReply(t){t&&(this.replyingTo=t,this.forceUi())}cancelReply(){this.replyingTo=null,this.forceUi()}replyPreview(t){let e=this.parseReply(String(t?.body??""));if(!e)return null;let i=this.messages.find(d=>d.id===e.targetId)??null,n=i?this.displayNameFor(this.senderInfo(i)):"Message",a=e.text||(i?this.messageText(i):"");return!a&&i?.media_type&&(a=i.media_type==="video"?"Video":"Photo"),a?{id:e.targetId,name:n,text:a}:null}scrollToMessage(t){if(!t)return;let e=document.getElementById(`msg-${t}`);if(e){e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("message-highlight"),window.setTimeout(()=>e.classList.remove("message-highlight"),900);return}this.scrollToBottom()}replySnippet(t){if(!t)return"";let e=this.messageText(t);return e||(t.media_type==="video"?"Video":t.media_type==="image"?"Photo":"")}isReactionMessage(t){return!!this.parseReaction(String(t?.body??""))}messageLikeCount(t){return this.reactionsByMessage.get(t.id)?.count??0}isMessageLikedByMe(t){return!!this.reactionsByMessage.get(t.id)?.likedByMe}async toggleMessageLike(t){if(!this.activeConversationId||!t?.id)return;let e=this.isMessageLikedByMe(t),i=this.buildReactionBody(t.id,e?0:1);try{let n=await this.messagesService.sendMessage(this.activeConversationId,i);this.messages=[...this.messages,n],this.bumpConversation(n),this.rebuildReactions(),this.forceUi()}catch{}}isCallLogMessage(t){let e=String(t?.body??"").trim();return e.includes(this.callLogPrefix)||!!this.parseCallLog(e)}buildCallLogBody(t,e,i){let n=Math.max(0,Math.floor(i));return`${this.callLogPrefix}status=${t}|kind=${e}|duration=${n}`}parseCallLog(t){let e=t.replace(/\uFEFF/g,"").trim(),n=(e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e).match(/__call__\|status=([^|]+)\|kind=(audio|video)\|duration=([0-9]+)/i);if(!n)return null;let a=String(n[1]??"").trim().toLowerCase(),d=n[2]==="video"?"video":"audio",m=Number(n[3]??0);return a?{status:a,kind:d,duration:Number.isFinite(m)?m:0}:null}buildReplyBody(t,e){let i=t?.id??"",n=this.messageText(t)||"",a=this.encodeBase64(n.slice(0,160));return`${this.REPLY_PREFIX}id=${i}|text=${a}||${e}`}parseReply(t){let e=String(t??"").trim();if(!e.startsWith(this.REPLY_PREFIX))return null;let i=e.split("||"),n=i[0]??"",a=i.slice(1).join("||"),d=n.match(/id=([^|]+)/i),m=n.match(/text=([^|]+)/i),h=d?String(d[1]):"",x=m?this.decodeBase64(String(m[1])):"";return{targetId:h,text:x,body:a}}buildReactionBody(t,e){return`${this.REACTION_PREFIX}target=${t}|emoji=\u2764|state=${e}`}parseReaction(t){let e=String(t??"").trim();if(!e.startsWith(this.REACTION_PREFIX))return null;let i=e.match(/target=([^|]+)/i),n=e.match(/emoji=([^|]+)/i),a=e.match(/state=([01])/i);return i?{targetId:String(i[1]),emoji:n?String(n[1]):"\u2764",state:a?Number(a[1]):1}:null}rebuildReactions(){let t=new Map;for(let i of this.messages){let n=this.parseReaction(i.body);if(!n)continue;let a=n.targetId,d=i.sender_id||"";!a||!d||(t.has(a)||t.set(a,new Map),t.get(a).set(d,n.state))}let e=new Map;for(let[i,n]of t.entries()){let a=0,d=!1;for(let[m,h]of n.entries())h===1&&(a+=1),m===this.meId&&h===1&&(d=!0);e.set(i,{count:a,likedByMe:d})}this.reactionsByMessage=e}encodeBase64(t){try{return btoa(unescape(encodeURIComponent(t)))}catch{return""}}decodeBase64(t){try{return decodeURIComponent(escape(atob(t)))}catch{return""}}formatCallLog(t){let e=t.kind==="video"?"Video call":"Voice call",i="";return t.status==="ended"?(i=`${e} ended`,t.duration>0&&(i+=` (${this.formatDuration(t.duration)})`),i):t.status==="missed"?`Missed ${e}`:t.status==="busy"?`Missed ${e}`:t.status==="declined"?`${e} declined`:`${e} call`}formatDuration(t){let e=Math.max(0,Math.floor(t)),i=Math.floor(e/3600),n=Math.floor(e%3600/60),a=e%60;return i>0?`${i}:${String(n).padStart(2,"0")}:${String(a).padStart(2,"0")}`:`${n}:${String(a).padStart(2,"0")}`}stripTrailingMeta(t){let e=t.split(/\s+/).filter(Boolean);if(e.length<2)return t;let i=e[e.length-1];return this.looksLikeId(i)?e.slice(0,-1).join(" "):t}resetMessageInput(){let t=this.messageInput?.nativeElement;if(!t)return;let e=32;t.style.height=`${e}px`,t.style.overflowY="hidden"}conversationSnippet(t){let e=t.last_message;if(!e)return"Start a conversation";let i=String(e.body||"").trim();if(this.parseReaction(i))return"Liked a message";let a=this.parseCallLog(i);if(a)return this.formatCallLog(a);let d=this.parseReply(i);if(d){let m=d.body.trim();if(m)return m}return i&&!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(i)?i:e.media_type==="video"?"Video":e.media_type==="image"?"Photo":"Media message"}bumpConversation(t){let e=t.conversation_id,i=this.conversations.findIndex(d=>d.id===e);if(i<0)return;let n=$(L({},this.conversations[i]),{last_message:t,last_message_at:t.created_at}),a=[...this.conversations];a.splice(i,1),this.conversations=[n,...a],this.activeConversation=n,this.forceUi()}otherMember(t){return t?this.meId?t.members.find(e=>e.user_id!==this.meId)??t.members[0]??null:t.members[0]??null:null}displayNameFor(t){return t?this.cleanDisplayValue(t.display_name)||this.cleanDisplayValue(t.username)||"Member":"Conversation"}displayHandleFor(t){let e=this.cleanDisplayValue(t?.username);return e?`@${e}`:""}isConversationUnread(t){return this.unreadConversationIds.has(t.id)}get messagesBadgeCount(){return this.unreadConversationIds.size}async refreshUnreadConversations(){if(!this.meId){this.messageNotifications=[],this.unreadConversationIds.clear(),this.forceUi();return}try{let{notifications:t}=await this.notificationsService.list(80),e=(t??[]).filter(i=>!i.read_at&&this.isMessageNotification(i)&&typeof i.entity_id=="string");this.messageNotifications=e,this.unreadConversationIds=new Set(e.map(i=>String(i.entity_id)))}catch{}this.forceUi()}async markConversationNotificationsRead(t){if(!t||!this.messageNotifications.length){this.unreadConversationIds.delete(t);return}let e=this.messageNotifications.filter(i=>i.entity_id===t);if(!e.length){this.unreadConversationIds.delete(t),this.forceUi();return}try{await Promise.all(e.map(i=>this.notificationsService.markRead(i.id)))}catch{}this.messageNotifications=this.messageNotifications.filter(i=>i.entity_id!==t),this.unreadConversationIds.delete(t),this.forceUi()}isMessageNotification(t){return String(t?.type??"").toLowerCase()==="message"}senderInfo(t){if(t.sender)return t.sender;let e=this.activeConversation;return e?e.members.find(i=>i.user_id===t.sender_id)??null:null}senderAvatarUrl(t){return this.senderInfo(t)?.avatar_url??""}cleanDisplayValue(t){let e=String(t??"").trim();return!e||this.looksLikeId(e)?"":e}looksLikeId(t){return!!(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)||/^\d{8,}$/.test(t))}initialsFor(t){let i=this.displayNameFor(t).split(/\s+/).filter(Boolean),n=i[0]?.[0]??"M",a=i.length>1?i[i.length-1]?.[0]??"":"";return(n+a).toUpperCase()}formatTime(t){if(!t)return"";let e=String(t).trim(),i=this.parseTimestamp(e);return Number.isNaN(i.getTime())?"":i.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatTimestamp(t){let e=String(t??"").trim(),i=this.parseTimestamp(e);return Number.isNaN(i.getTime())?"":i.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatDayLabel(t){let e=this.parseTimestamp(String(t??"").trim());if(Number.isNaN(e.getTime()))return String(t??"");let i=new Date,n=e.getFullYear()===i.getFullYear();if(e.getFullYear()===i.getFullYear()&&e.getMonth()===i.getMonth()&&e.getDate()===i.getDate())return"Today";let d=new Date(i);return d.setDate(i.getDate()-1),e.getFullYear()===d.getFullYear()&&e.getMonth()===d.getMonth()&&e.getDate()===d.getDate()?"Yesterday":e.toLocaleDateString(void 0,L({month:"short",day:"numeric"},n?{}:{year:"numeric"}))}showDaySeparator(t){if(!this.messages.length||t<0)return!1;if(t===0)return!0;let e=this.dayKey(this.messages[t]?.created_at),i=this.dayKey(this.messages[t-1]?.created_at);return e!==i}showDaySeparatorVisible(t){if(!this.messages.length||t<0)return!1;let e=this.messages[t];if(!e||this.isReactionMessage(e))return!1;let i=t-1;for(;i>=0;){let n=this.messages[i];if(n&&!this.isReactionMessage(n)){let a=this.dayKey(e.created_at),d=this.dayKey(n.created_at);return a!==d}i-=1}return!0}messageStatus(t){if(!this.meId||t.sender_id!==this.meId)return null;let e=this.otherMember(this.activeConversation);if(!e)return"sent";let i=e.last_read_at?this.parseTimestamp(e.last_read_at).getTime():0,n=this.parseTimestamp(t.created_at).getTime();return i&&n&&i>=n?"read":"sent"}statusGlyph(t){return t==="read"?"&#10003;&#10003;":"&#10003;"}isEdited(t){if(!t?.updated_at)return!1;let e=this.parseTimestamp(t.created_at).getTime(),i=this.parseTimestamp(t.updated_at).getTime();return!e||!i?!1:i>e+1e3}isEditing(t){return!!t&&this.editingMessageId===t.id}startEditMessage(t){if(!this.meId||t.sender_id!==this.meId||this.isCallLogMessage(t))return;let e=String(t.body??"").trim();e&&(this.editingMessageId=t.id,this.editingDraft=e,this.forceUi())}cancelEditMessage(){this.editingMessageId=null,this.editingDraft="",this.editBusy=!1,this.forceUi()}async saveEditMessage(t){if(!this.editingMessageId||this.editBusy||!this.meId||t.sender_id!==this.meId)return;let e=this.editingDraft.trim();if(e){this.editBusy=!0,this.messageError="",this.forceUi();try{let i=await this.messagesService.updateMessage(t.id,e);this.messages=this.messages.map(n=>n.id===t.id?i:n),this.editingMessageId=null,this.editingDraft="",this.bumpConversation(i),await this.loadConversations(this.activeConversationId)}catch(i){this.messageError=i?.message??String(i)}finally{this.editBusy=!1,this.forceUi()}}}async deleteMessage(t){if(!(!this.meId||t.sender_id!==this.meId||!(!(typeof window<"u")||window.confirm("Delete this message?")))){this.messageError="",this.forceUi();try{if(!await this.messagesService.deleteMessage(t.id))return;this.messages=this.messages.filter(n=>n.id!==t.id),await this.loadConversations(this.activeConversationId)}catch(i){this.messageError=i?.message??String(i)}finally{this.forceUi()}}}parseTimestamp(t){if(!t)return new Date("");if(/^\d{10,}$/.test(t)){let e=Number(t),i=t.length===10?e*1e3:e;return new Date(i)}return new Date(t)}dayKey(t){let e=this.parseTimestamp(String(t??"").trim());if(Number.isNaN(e.getTime()))return"";let i=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return`${i}-${n}-${a}`}enterThreadView(){typeof window>"u"||(this.mobileThreadOnly=window.innerWidth<=900,this.updateViewportFlag())}showConversationList(){this.mobileThreadOnly=!1,this.updateViewportFlag(),this.forceUi()}updateViewportFlag(){typeof window>"u"||(this.isNarrow=window.innerWidth<=900)}ensureLiveKitLoaded(){return this.livekitModule||window.LiveKit||window.livekit?(this.livekitModule=this.livekitModule||window.LiveKit||window.livekit,Promise.resolve()):this.livekitLoadPromise?this.livekitLoadPromise:(this.livekitLoadPromise=(async()=>{try{let t=await import("./chunk-IKEP2KGG.js");this.livekitModule=t,window.LiveKit=t;return}catch{}return new Promise((t,e)=>{let i=document.querySelector("script[data-livekit]"),n=()=>window.LiveKit||window.livekit||window.Livekit;if(i){let d=n();if(d){this.livekitModule=d,t();return}}let a=document.createElement("script");a.src="https://unpkg.com/livekit-client@2.17.1/dist/livekit-client.umd.min.js",a.async=!0,a.defer=!0,a.dataset.livekit="1",a.onload=()=>{let d=n();if(d){this.livekitModule=d,t();return}e(new Error("LiveKit not loaded."))},a.onerror=()=>{let d=document.createElement("script");d.src="https://cdn.jsdelivr.net/npm/livekit-client@2.17.1/dist/livekit-client.umd.min.js",d.async=!0,d.defer=!0,d.dataset.livekit="1-fallback",d.onload=()=>{let m=n();if(m){this.livekitModule=m,t();return}e(new Error("LiveKit not loaded."))},d.onerror=()=>e(new Error("LiveKit not loaded.")),document.head.appendChild(d)},document.head.appendChild(a)})})(),this.livekitLoadPromise)}forceUi(){this.zone.run(()=>this.cdr.detectChanges())}goBack(){this.router.navigate(["/globe"])}goHome(){this.router.navigate(["/globe"])}openNotifications(){this.router.navigate(["/globe"],{queryParams:{panel:"notifications"}})}openSearch(){this.router.navigate(["/globe"],{queryParams:{search:"1"}})}static \u0275fac=function(e){return new(e||s)(w(X),w(Z),w(J),w(pe),w(le),w(de),w(me),w(he),w(j),w(W))};static \u0275cmp=H({type:s,selectors:[["app-messages-page"]],viewQuery:function(e,i){if(e&1&&q(_e,5)(ve,5)(xe,5)(Ce,5)(ye,5),e&2){let n;T(n=O())&&(i.mediaInput=n.first),T(n=O())&&(i.messageInput=n.first),T(n=O())&&(i.messageList=n.first),T(n=O())&&(i.remoteVideo=n.first),T(n=O())&&(i.localVideo=n.first)}},decls:17,vars:10,consts:[["emptyThread",""],["messageList",""],["mediaInput",""],["messageInput",""],["activeControls",""],["remoteVideo",""],["localVideo",""],[1,"wrap"],[1,"card"],[1,"layout"],[1,"panel"],[1,"panel-title"],["type","button",1,"panel-backlink",3,"click"],["class","status",4,"ngIf"],["class","status error",4,"ngIf"],["class","conversation","type","button",3,"active","click",4,"ngFor","ngForOf"],["class","thread",4,"ngIf"],[4,"ngIf"],["class","lightbox",3,"click",4,"ngIf"],["class","call-overlay",4,"ngIf"],[1,"status"],[1,"status","error"],["type","button",1,"conversation",3,"click"],[1,"avatar"],["alt","avatar",3,"src",4,"ngIf"],["class","initials",4,"ngIf"],[1,"meta"],[1,"name"],[1,"snippet"],[1,"time"],["class","conversation-unread",4,"ngIf"],["alt","avatar",3,"src"],[1,"initials"],[1,"conversation-unread"],[1,"thread"],["class","thread-header",4,"ngIf","ngIfElse"],["class","messages",4,"ngIf"],["class","composer",3,"ngSubmit",4,"ngIf"],[1,"thread-header"],["class","thread-back","type","button",3,"click",4,"ngIf"],[1,"avatar","large"],[1,"thread-meta"],[1,"thread-name"],["class","thread-sub",4,"ngIf"],[1,"thread-actions"],["type","button",1,"thread-backlink",3,"click"],["type","button","aria-label","Start voice call",1,"call-btn",3,"click","disabled"],["src","assets/phonecall.svg","alt","","aria-hidden","true",1,"call-icon"],["type","button","aria-label","Start video call",1,"call-btn",3,"click","disabled"],["src","assets/videocall.svg","alt","","aria-hidden","true",1,"call-icon"],["type","button",1,"thread-back",3,"click"],[1,"thread-sub"],[1,"thread-empty"],[1,"messages"],["class","message-list",4,"ngIf"],[1,"message-list"],[4,"ngFor","ngForOf","ngForTrackBy"],["class","message-day",4,"ngIf"],[1,"message"],[1,"msg-avatar"],[1,"bubble"],["class","reply-preview",3,"click",4,"ngIf"],["class","body",3,"call-log",4,"ngIf"],["class","message-media",4,"ngIf"],[1,"message-meta"],[1,"message-time"],[1,"message-date"],["class","message-edited",4,"ngIf"],["class","message-status",3,"read","innerHTML",4,"ngIf"],[1,"message-reactions"],["type","button","title","Reply",1,"message-reply",3,"click"],["type","button","title","Like",1,"message-like",3,"click"],[1,"heart"],["class","message-actions",4,"ngIf"],["class","message-edit",4,"ngIf"],[1,"message-day"],[1,"reply-preview",3,"click"],[1,"reply-meta"],[1,"reply-text"],[1,"body"],[1,"message-media"],["alt","message media",3,"src","click",4,"ngIf"],[3,"src",4,"ngIf"],["target","_blank","rel","noopener",1,"media-download",3,"href"],["alt","message media",3,"click","src"],[3,"src"],[1,"message-edited"],[1,"message-status",3,"innerHTML"],[1,"message-actions"],["type","button",1,"message-action",3,"click"],["type","button",1,"message-action","danger",3,"click"],[1,"message-edit"],["rows","2",1,"message-edit-input",3,"ngModelChange","ngModel"],[1,"message-edit-actions"],["type","button",1,"ghost",3,"click"],["type","button",1,"save",3,"click","disabled"],[1,"composer",3,"ngSubmit"],["class","composer-reply",4,"ngIf"],[1,"composer-row"],["type","file","accept","image/png,image/jpeg,image/webp,video/mp4,video/webm,video/quicktime","hidden","",3,"change"],[1,"composer-field"],["type","button","title","Add media",1,"composer-attach",3,"click"],["name","message","placeholder","Write a message...","maxlength","2000","rows","1",1,"composer-input",3,"ngModelChange","input","ngModel"],["class","composer-preview",4,"ngIf"],["type","submit",1,"composer-send",3,"disabled"],[1,"composer-reply"],[1,"composer-reply-text"],["type","button",1,"composer-reply-close",3,"click"],[1,"composer-preview"],["alt","preview",3,"src",4,"ngIf"],["muted","","playsinline","",3,"src",4,"ngIf"],["type","button",1,"composer-clear",3,"click"],["alt","preview",3,"src"],["muted","","playsinline","",3,"src"],[1,"lightbox",3,"click"],[1,"lightbox-card",3,"click"],[1,"lightbox-frame"],["type","button",1,"lightbox-close",3,"click"],["alt","Preview",3,"src"],[1,"call-overlay"],[1,"call-card",3,"click"],[1,"call-top"],["src","/logo.png","alt","Matterya",1,"call-logo"],[1,"call-title"],[1,"call-sub"],[1,"call-timer"],[1,"call-body"],["class","call-remote","autoplay","","playsinline","",4,"ngIf"],["class","call-avatar",3,"speaking",4,"ngIf"],["class","call-local","autoplay","","muted","","playsinline","",4,"ngIf"],[1,"call-controls"],[4,"ngIf","ngIfElse"],["autoplay","","playsinline","",1,"call-remote"],[1,"call-avatar"],["autoplay","","muted","","playsinline","",1,"call-local"],["type","button",1,"call-action","accept",3,"click"],["type","button",1,"call-action","end",3,"click"],["type","button",1,"call-action","ghost",3,"click"],["class","call-action ghost","type","button",3,"click",4,"ngIf"]],template:function(e,i){e&1&&(r(0,"div",7)(1,"div",8)(2,"div",9)(3,"aside",10)(4,"div",11)(5,"span"),p(6,"Messages"),c(),r(7,"button",12),_("click",function(){return i.goBack()}),p(8,"Back"),c()(),v(9,be,2,0,"div",13)(10,Me,2,1,"div",14)(11,we,2,0,"div",13)(12,ke,12,8,"button",15),c(),v(13,st,6,4,"section",16),c()()(),v(14,ot,1,0,"app-bottom-tabs",17)(15,rt,6,1,"div",18)(16,ft,19,10,"div",19)),e&2&&(o(2),S("thread-only",i.mobileThreadOnly),o(7),g("ngIf",i.loadingConversations),o(),g("ngIf",i.conversationError),o(),g("ngIf",!i.loadingConversations&&!i.conversations.length),o(),g("ngForOf",i.conversations),o(),g("ngIf",i.activeConversation||!i.isNarrow),o(),g("ngIf",!i.activeConversation),o(),g("ngIf",i.lightboxUrl),o(),g("ngIf",i.callUiOpen))},dependencies:[G,Y,Q,re,se,ee,te,ie,oe,ae,ne,ce,ge],styles:["[_nghost-%COMP%]{display:block;min-height:100svh;height:100svh;position:relative;color:#e6f1ff;background:transparent}.wrap[_ngcontent-%COMP%]{min-height:100%;height:100%;position:relative;padding:0 0 var(--tabs-safe, 64px);box-sizing:border-box;display:flex;flex-direction:column}.card[_ngcontent-%COMP%]{position:relative;z-index:1;width:100%;height:100%;max-width:none;margin:0;background:transparent;border-radius:0;padding:0;border:0;box-shadow:none;-webkit-backdrop-filter:none;backdrop-filter:none;color:#0c1422;flex:1;box-sizing:border-box;display:flex;flex-direction:column;min-height:0;overflow:hidden}.layout[_ngcontent-%COMP%]{display:grid;grid-template-columns:320px 1fr;gap:0;align-items:stretch;flex:1;min-height:0}.layout.thread-only[_ngcontent-%COMP%]   .panel[_ngcontent-%COMP%]{display:none}.panel[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:10px;background:transparent;border-radius:0;padding:14px;border:0;min-height:0;overflow:auto}.panel-title[_ngcontent-%COMP%]{font-weight:800;letter-spacing:.24em;text-transform:uppercase;font-size:11px;color:#09162699;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between;gap:10px}.panel-backlink[_ngcontent-%COMP%]{border:0;background:transparent;color:#0a1420d9;letter-spacing:.14em;font-size:10px;text-transform:uppercase;cursor:pointer;padding:4px 6px}.status[_ngcontent-%COMP%]{font-size:13px;opacity:.7;padding:6px 0}.status.error[_ngcontent-%COMP%]{color:#c55c5c}.conversation[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px;padding:10px;border-radius:16px;border:1px solid transparent;background:#07142808;cursor:pointer;text-align:left;transition:border .16s ease,background .16s ease,transform .16s ease}.conversation[_ngcontent-%COMP%]:hover{border-color:#009bdc4d;background:#009bdc1a;transform:translateY(-1px)}.conversation.active[_ngcontent-%COMP%]{border-color:#009bdc80;background:#009bdc26}.conversation-unread[_ngcontent-%COMP%]{width:8px;height:8px;border-radius:999px;background:#ffffffe6;border:1px solid rgba(7,20,40,.12);flex:0 0 auto;margin-left:6px}.avatar[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;overflow:hidden;background:#009bdc1f;display:flex;align-items:center;justify-content:center;font-weight:800;color:#051928bf;flex-shrink:0}.avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.avatar.large[_ngcontent-%COMP%]{width:48px;height:48px}.meta[_ngcontent-%COMP%]{flex:1;min-width:0}.name[_ngcontent-%COMP%]{font-weight:700;font-size:14px;color:#06101ee6;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.snippet[_ngcontent-%COMP%]{font-size:12px;opacity:.6;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.time[_ngcontent-%COMP%]{font-size:11px;opacity:.5;margin-left:auto;white-space:nowrap}.thread[_ngcontent-%COMP%]{display:flex;flex-direction:column;border-radius:0;border:0;background:transparent;overflow:hidden;min-height:0}.thread-back[_ngcontent-%COMP%]{border:0;background:none;color:#07142899;font-size:11px;letter-spacing:.18em;text-transform:uppercase;cursor:pointer;margin-right:8px}.thread-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;padding:14px;border-bottom:1px solid rgba(7,20,40,.12);background:transparent;min-width:0}.thread-backlink[_ngcontent-%COMP%]{margin-left:auto;border:0;background:transparent;color:#0a1420d9;letter-spacing:.14em;font-size:11px;text-transform:uppercase;cursor:pointer;padding:6px 10px}.thread-meta[_ngcontent-%COMP%]{min-width:0;flex:1}.thread-name[_ngcontent-%COMP%]{font-weight:800;font-size:16px;color:#07101ce6;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.thread-sub[_ngcontent-%COMP%]{font-size:12px;opacity:.6;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.thread-actions[_ngcontent-%COMP%]{margin-left:auto;display:flex;gap:8px;flex-shrink:0}.call-btn[_ngcontent-%COMP%]{width:34px;height:34px;border-radius:10px;border:1px solid rgba(7,20,40,.15);background:#071c2a0f;color:#071428e6;font-size:16px;cursor:pointer;display:grid;place-items:center}.call-icon[_ngcontent-%COMP%]{width:18px;height:18px;display:block;object-fit:contain;filter:invert(14%) sepia(10%) saturate(380%) hue-rotate(178deg) brightness(92%) contrast(92%)}.call-btn[_ngcontent-%COMP%]:disabled{opacity:.45;cursor:not-allowed}.thread-empty[_ngcontent-%COMP%]{padding:24px;font-size:14px;opacity:.6}.messages[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden}.message-list[_ngcontent-%COMP%]{flex:1;padding:14px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;min-height:0}.message-day[_ngcontent-%COMP%]{align-self:center;font-size:11px;letter-spacing:.12em;text-transform:uppercase;color:#0714288c;background:#0714280f;border:1px solid rgba(7,20,40,.08);border-radius:999px;padding:6px 12px}.message[_ngcontent-%COMP%]{display:flex;align-items:flex-end;gap:10px;width:100%}.message.me[_ngcontent-%COMP%]{justify-content:flex-end}.message.me[_ngcontent-%COMP%]   .msg-avatar[_ngcontent-%COMP%]{order:2}.message.me[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{order:1}.msg-avatar[_ngcontent-%COMP%]{width:28px;height:28px;border-radius:50%;overflow:hidden;background:#0714281a;border:1px solid rgba(7,20,40,.12);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#071428bf;flex-shrink:0}.msg-avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.bubble[_ngcontent-%COMP%]{max-width:72%;background:#0714280d;border:1px solid rgba(7,20,40,.08);border-radius:18px;padding:10px 12px;font-size:14px;line-height:1.5}.message.me[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{background:#009bdc2e;border-color:#009bdc66}.body[_ngcontent-%COMP%]{white-space:pre-wrap;word-break:break-word}.message.call-log[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{background:#0714280f;border:1px dashed rgba(7,20,40,.2);box-shadow:none}.message.call-log[_ngcontent-%COMP%]   .body[_ngcontent-%COMP%]{font-style:italic;color:#071428b3;text-align:center;letter-spacing:.02em}.message.call-log.me[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{background:#08284614}.message-media[_ngcontent-%COMP%]{margin-top:8px;display:flex;flex-direction:column;gap:8px}.message-media[_ngcontent-%COMP%]   img[_ngcontent-%COMP%], .message-media[_ngcontent-%COMP%]   app-video-player[_ngcontent-%COMP%]{width:100%;border-radius:14px;overflow:hidden;border:1px solid rgba(7,20,40,.12);background:#000}.message-media[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{display:block;object-fit:cover;cursor:pointer}.message-media[_ngcontent-%COMP%]   app-video-player[_ngcontent-%COMP%]{width:100%}.message-media[_ngcontent-%COMP%]   app-video-player[_ngcontent-%COMP%]     .video-shell{max-height:none}.message-media[_ngcontent-%COMP%]   app-video-player[_ngcontent-%COMP%]     video{height:100%;width:100%;object-fit:contain}.media-download[_ngcontent-%COMP%]{font-size:11px;letter-spacing:.08em;text-transform:uppercase;font-weight:700;color:#071428a6;text-decoration:none}.message-time[_ngcontent-%COMP%]{font-size:10px;opacity:.6}.message-meta[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:flex-end;gap:8px;margin-top:6px}.message-reactions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:8px;margin-top:6px}.message-like[_ngcontent-%COMP%], .message-reply[_ngcontent-%COMP%]{border:0;background:#ffffffa6;color:#071428e6;font-size:10px;letter-spacing:.08em;text-transform:uppercase;padding:4px 8px;border-radius:999px;cursor:pointer}.message-like[_ngcontent-%COMP%]   .heart[_ngcontent-%COMP%]{color:#071428f2}.message-like.active[_ngcontent-%COMP%]{color:#ff6b8a;background:#ff6b8a2e}.message-like.active[_ngcontent-%COMP%]   .heart[_ngcontent-%COMP%]{color:#ff6b8a}.message-date[_ngcontent-%COMP%]{margin-left:6px;font-size:10px;opacity:.6}.message-edited[_ngcontent-%COMP%]{font-size:10px;text-transform:uppercase;letter-spacing:.12em;color:#0714288c}.message-status[_ngcontent-%COMP%]{font-size:11px;letter-spacing:.08em;opacity:.7;color:#07142899}.message-status.read[_ngcontent-%COMP%]{color:#009bdcf2;opacity:1}.message-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:10px;margin-top:6px}.reply-preview[_ngcontent-%COMP%]{border-left:2px solid rgba(120,210,255,.6);padding-left:10px;margin-bottom:8px;font-size:12px;opacity:.9}.reply-meta[_ngcontent-%COMP%]{font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:.12em;opacity:.7}.reply-text[_ngcontent-%COMP%]{margin-top:4px;opacity:.85}.message-action[_ngcontent-%COMP%]{border:0;background:none;font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:#071428a6;cursor:pointer}.message-action.danger[_ngcontent-%COMP%]{color:#c84646e6}.message-edit[_ngcontent-%COMP%]{margin-top:8px;display:flex;flex-direction:column;gap:8px}.message-edit-input[_ngcontent-%COMP%]{width:100%;border-radius:12px;border:1px solid rgba(7,20,40,.18);padding:8px 10px;font-family:inherit;font-size:13px;resize:vertical;min-height:60px}.message-edit-actions[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:8px}.composer-reply[_ngcontent-%COMP%]{position:relative;padding:8px 10px;border-radius:12px;background:#ffffff14;margin:0 0 8px;font-size:12px;color:#eef6ff}.composer-reply-text[_ngcontent-%COMP%]{margin-top:4px;opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.composer-reply-close[_ngcontent-%COMP%]{position:absolute;right:8px;top:6px;border:0;background:transparent;color:#fff;font-size:16px;cursor:pointer}.message-highlight[_ngcontent-%COMP%]   .bubble[_ngcontent-%COMP%]{box-shadow:0 0 0 2px #78d2ff8c,0 0 20px #78d2ff59}.message-edit-actions[_ngcontent-%COMP%]   .ghost[_ngcontent-%COMP%]{border:0;background:none;font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:#07142899;cursor:pointer}.message-edit-actions[_ngcontent-%COMP%]   .save[_ngcontent-%COMP%]{border:0;border-radius:999px;padding:6px 14px;background:#009bdce6;color:#fff;font-size:11px;letter-spacing:.08em;text-transform:uppercase;cursor:pointer}@media(max-width:600px){.message-media[_ngcontent-%COMP%]   app-video-player[_ngcontent-%COMP%]     .video-shell{max-height:240px}.message-media[_ngcontent-%COMP%]   app-video-player[_ngcontent-%COMP%]     video{max-height:240px}}.composer[_ngcontent-%COMP%]{position:sticky;bottom:0;z-index:5;display:flex;flex-direction:column;gap:10px;padding:12px 14px;border-top:1px solid rgba(7,20,40,.08);background:#fffffff2;padding-bottom:calc(12px + env(safe-area-inset-bottom))}.composer-row[_ngcontent-%COMP%]{display:flex;gap:10px;align-items:flex-end}.composer-field[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:8px;border-radius:16px;border:1px solid rgba(7,20,40,.14);background:#fff;padding:10px 12px 10px 44px;min-height:56px;position:relative}.composer-input[_ngcontent-%COMP%]{width:100%;border:0;padding:4px 0;font-size:14px;font-family:inherit;background:transparent;min-height:32px;max-height:160px;line-height:1.45;resize:none;overflow-y:hidden}.composer-attach[_ngcontent-%COMP%]{position:absolute;left:10px;top:10px;width:26px;height:26px;border-radius:50%;border:1px solid rgba(7,20,40,.15);background:#0714280f;font-weight:900;font-size:16px;line-height:1;cursor:pointer;color:#071428b3;display:grid;place-items:center}.composer-send[_ngcontent-%COMP%]{display:inline-flex;align-items:center;justify-content:center;min-height:44px;border:0;border-radius:999px;padding:10px 18px;background:#009bdcd9;color:#fff;font-weight:700;cursor:pointer;box-shadow:0 12px 24px #009bdc40}.composer-send[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed;box-shadow:none}.composer-preview[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;background:#0714280a;border:1px solid rgba(7,20,40,.12);border-radius:12px;padding:8px}.composer-preview[_ngcontent-%COMP%]   img[_ngcontent-%COMP%], .composer-preview[_ngcontent-%COMP%]   video[_ngcontent-%COMP%]{width:120px;height:80px;object-fit:cover;border-radius:10px;background:#000;border:1px solid rgba(7,20,40,.1)}.composer-clear[_ngcontent-%COMP%]{border:0;background:none;color:#07142899;font-weight:700;letter-spacing:.12em;text-transform:uppercase;font-size:10px;cursor:pointer}.lightbox[_ngcontent-%COMP%]{position:fixed;inset:0;background:#050a12b3;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);display:grid;place-items:center;z-index:100}.lightbox-card[_ngcontent-%COMP%]{position:relative;max-width:min(92vw,780px);max-height:80vh;background:#fffffff2;border-radius:18px;padding:12px;box-shadow:0 20px 50px #00000040}.lightbox-frame[_ngcontent-%COMP%]{position:relative}.lightbox-card[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:auto;max-height:70vh;display:block;border-radius:12px}.lightbox-close[_ngcontent-%COMP%]{position:absolute;top:6px;right:6px;width:30px;height:30px;border-radius:50%;border:1px solid rgba(7,20,40,.2);background:#fff;cursor:pointer;font-weight:800}.call-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#050a12bf;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);display:grid;place-items:center;z-index:120;padding:calc(16px + env(safe-area-inset-top)) 16px calc(16px + env(safe-area-inset-bottom))}.call-card[_ngcontent-%COMP%]{width:min(92vw,520px);height:min(86svh,680px);max-height:calc(100svh - 32px - env(safe-area-inset-top) - env(safe-area-inset-bottom));background:#08101cf5;border-radius:24px;padding:18px;display:flex;flex-direction:column;color:#e8f1ff;box-shadow:0 24px 60px #00000059;box-sizing:border-box}.call-card.video[_ngcontent-%COMP%]{width:min(96vw,720px);height:min(90svh,720px)}.call-top[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;margin-bottom:12px}.call-logo[_ngcontent-%COMP%]{width:32px;height:32px;border-radius:10px;object-fit:cover;background:#ffffff14}.call-title[_ngcontent-%COMP%]{font-weight:700;font-size:16px}.call-sub[_ngcontent-%COMP%]{font-size:12px;opacity:.7}.call-timer[_ngcontent-%COMP%]{margin-left:auto;font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:#ffffffb3}.call-body[_ngcontent-%COMP%]{flex:1;position:relative;display:flex;align-items:center;justify-content:center;border-radius:18px;background:#0003;overflow:hidden}.call-remote[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover;background:#000}.call-local[_ngcontent-%COMP%]{position:absolute;width:130px;height:96px;bottom:12px;right:12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:#000;object-fit:cover}.call-avatar[_ngcontent-%COMP%]{width:120px;height:120px;border-radius:50%;display:grid;place-items:center;background:#ffffff14;overflow:hidden;border:1px solid rgba(255,255,255,.08);box-shadow:0 0 #0000;transition:box-shadow .2s ease,transform .2s ease}.call-avatar.speaking[_ngcontent-%COMP%]{box-shadow:0 0 0 6px #009bdc2e,0 0 18px #009bdc73;transform:scale(1.03)}.call-avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.call-controls[_ngcontent-%COMP%]{margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}.call-action[_ngcontent-%COMP%]{border:0;border-radius:18px;padding:10px 16px;background:#ffffff1f;color:#eef6ff;font-weight:600;cursor:pointer}.call-action.ghost[_ngcontent-%COMP%]{background:#ffffff14}.call-action.accept[_ngcontent-%COMP%]{background:#2f9d66;color:#fff}.call-action.end[_ngcontent-%COMP%]{background:#d84c4c;color:#fff}@media(max-width:900px){.wrap[_ngcontent-%COMP%]{padding:0}.layout[_ngcontent-%COMP%]{grid-template-columns:1fr;height:100%;gap:12px}.panel[_ngcontent-%COMP%]{max-height:240px;overflow:auto}.layout.thread-only[_ngcontent-%COMP%]{height:100%}.thread[_ngcontent-%COMP%]{min-height:0;height:100%}.messages[_ngcontent-%COMP%], .message-list[_ngcontent-%COMP%]{min-height:0}.thread-header[_ngcontent-%COMP%]{flex-wrap:wrap}.thread-actions[_ngcontent-%COMP%]{align-items:center}}@media(max-width:600px){.wrap[_ngcontent-%COMP%], .card[_ngcontent-%COMP%]{padding:0}.bubble[_ngcontent-%COMP%]{max-width:86%}.composer-send[_ngcontent-%COMP%]{width:100%}.composer-row[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}.composer-attach[_ngcontent-%COMP%]{left:8px;top:8px;width:24px;height:24px;font-size:15px;border-radius:50%}.call-card[_ngcontent-%COMP%]{height:min(80svh,600px);max-height:calc(100svh - 32px - env(safe-area-inset-top) - env(safe-area-inset-bottom))}.call-local[_ngcontent-%COMP%]{width:96px;height:72px}.thread-actions[_ngcontent-%COMP%]{align-items:center;gap:6px}.thread-header[_ngcontent-%COMP%]{flex-wrap:nowrap;align-items:center}.thread-meta[_ngcontent-%COMP%]{min-width:0}.thread-name[_ngcontent-%COMP%]{font-size:14px}}"]})};export{ue as MessagesPageComponent};
