import{a as L}from"./chunk-7L72BQGT.js";import{a as j}from"./chunk-JFWLUDT4.js";import{a as T,b as A,e as D,h as U,i as q,j as z,o as B}from"./chunk-KSNNJYBO.js";import{a as I}from"./chunk-AFJFBD4M.js";import"./chunk-LQQHCQP3.js";import{c as O}from"./chunk-KO5X6LCN.js";import{D as l,Da as N,G as p,H as S,Ia as E,L as f,P as u,Q as a,R as n,Y as P,Z as m,_ as y,fa as o,ga as g,ha as h,ja as v,ka as b,la as C,p as _,q as x,ua as w,xa as M,ya as k}from"./chunk-SPQ2JWKS.js";import"./chunk-2NFLSA4Y.js";function W(s,i){s&1&&(a(0,"small",23),o(1,"Selected \u2705"),n())}function V(s,i){if(s&1&&(a(0,"option",27),o(1),n()),s&2){let t=i.$implicit;u("value",t.name),l(),g(t.name)}}function $(s,i){if(s&1){let t=P();a(0,"div",6)(1,"label"),o(2,"Manual country"),n(),a(3,"select",24),C("ngModelChange",function(r){_(t);let c=y();return b(c.manualCountryName,r)||(c.manualCountryName=r),x(r)}),a(4,"option",25),o(5,"Select\u2026"),n(),f(6,V,2,2,"option",26),n(),a(7,"small",23),o(8,"Used only if auto-detect fails."),n()()}if(s&2){let t=y();l(3),v("ngModel",t.manualCountryName),l(3),u("ngForOf",t.countries)}}function G(s,i){if(s&1&&(a(0,"div",28),o(1),n()),s&2){let t=y();l(),g(t.msg)}}var F=class s{constructor(i,t,e,r,c,d){this.auth=i;this.countriesService=t;this.gql=e;this.media=r;this.router=c;this.cdr=d}countries=[];displayName="";avatarUrl=null;detecting=!1;detectSource="";countryName="";countryCode="";cityName="";manual=!1;manualCountryName="";busy=!1;msg="";async ngOnInit(){let i=await this.auth.getUser();if(!i){await this.router.navigateByUrl("/auth");return}this.displayName=i.email?.split("@")[0]??"User";let t=await this.countriesService.loadCountries();this.countries=t.countries??[],this.cdr.detectChanges(),queueMicrotask(()=>this.detect())}async onAvatar(i){let t=i.target,e=t.files?.[0];if(e){this.msg="";try{let r=await this.media.uploadAvatar(e);this.avatarUrl=r.url}catch(r){this.msg=`Avatar upload failed: ${r?.message??r}`}finally{t.value="",this.cdr.detectChanges()}}}async detect(){this.msg="",this.detecting=!0,this.detectSource="";try{let i=await this.getBrowserCoords(9e3);if(!i){this.manual=!0,this.detectSource="location unavailable";return}let e=(await this.gql.query(`
        mutation Detect($lat: Float!, $lng: Float!) {
          detectLocation(lat: $lat, lng: $lng) {
            countryCode
            countryName
            cityName
            source
          }
        }
        `,{lat:i.lat,lng:i.lng})).detectLocation;this.countryName=e.countryName,this.countryCode=e.countryCode,this.cityName=e.cityName??"",this.detectSource=e.source,this.manual=!1}catch(i){this.manual=!0,this.detectSource="detect failed",this.msg=i?.message??String(i)}finally{this.detecting=!1,this.cdr.detectChanges()}}async save(){this.msg="",this.busy=!0;try{let i=this.displayName.trim();if(!i)throw new Error("Screen name is required.");let t=(this.countryName||"").trim(),e=(this.countryCode||"").trim(),r=(this.cityName||"").trim();if(!t||t==="Unknown"){if(!this.manualCountryName)throw new Error("Auto-detect failed. Select a country manually.");let c=this.manualCountryName.trim().toLowerCase(),d=this.countries.find(R=>R.name.trim().toLowerCase()===c);if(!d?.code)throw new Error("Selected country has no code. Pick another country.");t=d.name,e=d.code,r="",this.countryName=t,this.countryCode=e,this.cityName="",this.detectSource="manual selection"}await this.gql.query(`
        mutation Update($input: UpdateProfileInput!) {
          updateProfile(input: $input) { user_id }
        }
        `,{input:{display_name:i,avatar_url:this.avatarUrl,country_name:t,country_code:e||null,city_name:r||null}}),await this.router.navigateByUrl("/")}catch(i){this.msg=i?.message??String(i)}finally{this.busy=!1,this.cdr.detectChanges()}}async goBack(){if(history.length>1){history.back();return}await this.router.navigateByUrl("/")}getBrowserCoords(i){return new Promise(t=>{if(!("geolocation"in navigator))return t(null);let e=!1,r=d=>{e||(e=!0,t(d))},c=window.setTimeout(()=>r(null),i);navigator.geolocation.getCurrentPosition(d=>{clearTimeout(c),r({lat:d.coords.latitude,lng:d.coords.longitude})},()=>{clearTimeout(c),r(null)},{enableHighAccuracy:!1,timeout:i,maximumAge:6e4})})}static \u0275fac=function(t){return new(t||s)(p(O),p(I),p(L),p(j),p(E),p(w))};static \u0275cmp=S({type:s,selectors:[["app-profile-setup-page"]],decls:50,vars:12,consts:[[1,"wrap"],[1,"card"],[1,"topbar"],["type","button",1,"back",3,"click"],[1,"title"],[1,"sub"],[1,"field"],["placeholder","e.g. Amr",3,"ngModelChange","ngModel"],[1,"row"],[1,"btn2",2,"cursor","pointer"],["type","file","accept","image/*",2,"display","none",3,"change"],["class","muted",4,"ngIf"],[1,"locbox"],[1,"locrow"],[1,"k"],[1,"v"],[1,"row",2,"margin-top","10px"],["type","button",1,"btn2",3,"click","disabled"],["type","button",1,"link",3,"click"],["class","field",4,"ngIf"],[1,"row",2,"margin-top","16px"],[1,"btn",3,"click","disabled"],["class","msg",4,"ngIf"],[1,"muted"],[3,"ngModelChange","ngModel"],["value",""],[3,"value",4,"ngFor","ngForOf"],[3,"value"],[1,"msg"]],template:function(t,e){t&1&&(a(0,"div",0)(1,"div",1)(2,"div",2)(3,"button",3),m("click",function(){return e.goBack()}),o(4,"Back"),n()(),a(5,"div",4),o(6,"Create your profile"),n(),a(7,"div",5),o(8,"Auto-detect is default. Manual selection is fallback."),n(),a(9,"div",6)(10,"label"),o(11,"Screen name"),n(),a(12,"input",7),C("ngModelChange",function(c){return b(e.displayName,c)||(e.displayName=c),c}),n()(),a(13,"div",6)(14,"label"),o(15,"Avatar (optional)"),n(),a(16,"div",8)(17,"label",9),o(18," Choose image "),a(19,"input",10),m("change",function(c){return e.onAvatar(c)}),n()(),f(20,W,2,0,"small",11),n()(),a(21,"div",6)(22,"label"),o(23,"Detected location"),n(),a(24,"div",12)(25,"div",13)(26,"div",14),o(27,"Country"),n(),a(28,"div",15),o(29),n()(),a(30,"div",13)(31,"div",14),o(32,"City"),n(),a(33,"div",15),o(34),n()(),a(35,"div",13)(36,"div",14),o(37,"Status"),n(),a(38,"div",15),o(39),n()()(),a(40,"div",16)(41,"button",17),m("click",function(){return e.detect()}),o(42),n(),a(43,"button",18),m("click",function(){return e.manual=!e.manual}),o(44),n()()(),f(45,$,9,2,"div",19),a(46,"div",20)(47,"button",21),m("click",function(){return e.save()}),o(48),n(),f(49,G,2,1,"div",22),n()()()),t&2&&(l(12),v("ngModel",e.displayName),l(8),u("ngIf",e.avatarUrl),l(9),g(e.countryName||"\u2014"),l(5),g(e.cityName||"\u2014"),l(5),g(e.detecting?"Detecting\u2026":e.detectSource||"\u2014"),l(2),u("disabled",e.detecting),l(),h(" ",e.detecting?"Detecting\u2026":"Detect again"," "),l(2),h(" ",e.manual?"Hide manual":"Manual fallback"," "),l(),u("ngIf",e.manual),l(2),u("disabled",e.busy),l(),h(" ",e.busy?"Saving\u2026":"Save & Continue"," "),l(),u("ngIf",e.msg))},dependencies:[N,M,k,B,q,z,T,U,A,D],styles:["[_nghost-%COMP%]{display:block;height:100vh}.wrap[_ngcontent-%COMP%]{height:100vh;display:grid;place-items:center;background:radial-gradient(1200px 800px at 50% 30%,rgba(0,255,209,.1),transparent 60%),#06080ef2;color:#ffffffeb}.card[_ngcontent-%COMP%]{width:min(720px,92vw);border-radius:24px;padding:18px;background:#0a0c1499;border:1px solid rgba(0,255,209,.2);box-shadow:0 30px 90px #00000073;-webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px)}.title[_ngcontent-%COMP%]{font-weight:900;letter-spacing:.08em;font-size:18px}.sub[_ngcontent-%COMP%]{margin-top:6px;opacity:.7;font-size:13px}.topbar[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;margin-bottom:8px}.back[_ngcontent-%COMP%]{border:1px solid rgba(255,255,255,.12);background:#080a12bf;color:#ffffffd9;padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:800;letter-spacing:.08em;font-size:11px}.field[_ngcontent-%COMP%]{margin-top:14px;display:grid;gap:8px}label[_ngcontent-%COMP%]{font-size:12px;opacity:.75;letter-spacing:.12em}input[_ngcontent-%COMP%], select[_ngcontent-%COMP%]{padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:#00000047;color:#ffffffeb;outline:none}.locbox[_ngcontent-%COMP%]{border:1px solid rgba(255,255,255,.1);background:#0003;border-radius:16px;padding:12px;display:grid;gap:8px}.locrow[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:12px}.k[_ngcontent-%COMP%]{opacity:.7;font-size:12px}.v[_ngcontent-%COMP%]{font-weight:800;font-size:13px}.row[_ngcontent-%COMP%]{display:flex;gap:12px;align-items:center}.muted[_ngcontent-%COMP%]{opacity:.65;font-weight:600;font-size:12px}.btn[_ngcontent-%COMP%]{border:0;border-radius:16px;padding:12px 14px;cursor:pointer;background:linear-gradient(90deg,#00ffd1d9,#8c00ffbf);color:#06080ef5;font-weight:900;letter-spacing:.12em}.btn[_ngcontent-%COMP%]:disabled{opacity:.6;cursor:not-allowed}.btn2[_ngcontent-%COMP%]{border:1px solid rgba(255,255,255,.14);background:#ffffff0f;color:#ffffffe6;padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:900;letter-spacing:.08em;font-size:12px}.link[_ngcontent-%COMP%]{border:0;background:transparent;padding:0;color:#00ffd1e6;cursor:pointer;font-weight:900;letter-spacing:.08em;font-size:12px}.msg[_ngcontent-%COMP%]{font-size:13px;opacity:.95;white-space:pre-wrap}"]})};export{F as ProfileSetupPageComponent};
