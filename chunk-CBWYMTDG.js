import{a as D,b as N,e as j,g as z,k as W,o as B}from"./chunk-KSNNJYBO.js";import{a as K}from"./chunk-VEHW3HLT.js";import{a as F}from"./chunk-AFJFBD4M.js";import{a as R}from"./chunk-LQQHCQP3.js";import{D as d,Da as A,G as f,Ga as V,H as S,Ia as T,L as x,P as u,Q as o,R as i,S as k,Y as C,Z as m,_ as l,fa as c,ga as _,ha as b,ja as h,ka as y,la as P,p,q as g,xa as E,ya as I}from"./chunk-SPQ2JWKS.js";import{a as w,b as O}from"./chunk-2NFLSA4Y.js";function G(a,t){if(a&1&&(o(0,"div",11),c(1),i()),a&2){let e=l(2);d(),_(e.keyError)}}function $(a,t){if(a&1){let e=C();o(0,"div",4)(1,"div",5),c(2,"Admin access"),i(),o(3,"div",6),c(4," Enter the key or open this page with "),o(5,"code"),c(6,"?key=YOUR_KEY"),i(),c(7,". "),i(),o(8,"div",7)(9,"input",8),P("ngModelChange",function(n){p(e);let s=l();return y(s.keyInput,n)||(s.keyInput=n),g(n)}),m("keydown.enter",function(){p(e);let n=l();return g(n.unlock())}),i(),o(10,"button",9),m("click",function(){p(e);let n=l();return g(n.unlock())}),c(11,"Unlock"),i()(),x(12,G,2,1,"div",10),i()}if(a&2){let e=l();d(9),h("ngModel",e.keyInput),d(3),u("ngIf",e.keyError)}}function Q(a,t){if(a&1){let e=C();o(0,"div",21)(1,"div",22)(2,"div",23),c(3),i(),o(4,"div",24),c(5),i()(),o(6,"input",25),m("ngModelChange",function(n){let s=p(e).$implicit,v=l(2);return g(v.setOverrideValue(s.code,"total",n))}),i(),o(7,"input",25),m("ngModelChange",function(n){let s=p(e).$implicit,v=l(2);return g(v.setOverrideValue(s.code,"online",n))}),i(),o(8,"button",15),m("click",function(){let n=p(e).$implicit,s=l(2);return g(s.clearOverride(n.code))}),c(9," Clear "),i()()}if(a&2){let e=t.$implicit,r=l(2);d(3),_(e.name),d(2),_(e.code),d(),u("ngModel",r.overrideFor(e.code).total),d(),u("ngModel",r.overrideFor(e.code).online)}}function q(a,t){if(a&1){let e=C();o(0,"div",12)(1,"div",13)(2,"div")(3,"div",5),c(4,"Presence overrides"),i(),o(5,"div",6),c(6," Override totals and online counts per country. Empty means auto. "),i()(),o(7,"div",14)(8,"button",15),m("click",function(){p(e);let n=l();return g(n.resetAll())}),c(9,"Reset all"),i(),o(10,"button",9),m("click",function(){p(e);let n=l();return g(n.goBack())}),c(11,"Back to globe"),i()()(),o(12,"div",16)(13,"input",17),P("ngModelChange",function(n){p(e);let s=l();return y(s.filter,n)||(s.filter=n),g(n)}),m("ngModelChange",function(){p(e);let n=l();return g(n.applyFilter())}),i(),o(14,"div",18),c(15," Active overrides: "),o(16,"b"),c(17),i()()(),o(18,"div",19)(19,"div"),c(20,"Country"),i(),o(21,"div"),c(22,"Total"),i(),o(23,"div"),c(24,"Online"),i(),k(25,"div"),i(),x(26,Q,10,4,"div",20),i()}if(a&2){let e=l();d(13),h("ngModel",e.filter),d(4),_(e.overrideCount),d(9),u("ngForOf",e.filteredCountries)}}function H(a,t){if(a&1&&(o(0,"div",6),c(1),i()),a&2){let e=l(2);d(),_(e.cronStatus)}}function J(a,t){if(a&1){let e=C();o(0,"div",26)(1,"div",13)(2,"div")(3,"div",5),c(4,"Daily insights"),i(),o(5,"div",6),c(6,"Run the manual country insights refresh."),i()()(),o(7,"div",27)(8,"input",28),P("ngModelChange",function(n){p(e);let s=l();return y(s.cronSecretInput,n)||(s.cronSecretInput=n),g(n)}),i(),o(9,"button",29),m("click",function(){p(e);let n=l();return g(n.runDailyInsights())}),c(10),i()(),x(11,H,2,1,"div",30),i()}if(a&2){let e=l();d(8),h("ngModel",e.cronSecretInput),d(),u("disabled",e.cronRunning),d(),b(" ",e.cronRunning?"Running\u2026":"Run now"," "),d(),u("ngIf",e.cronStatus)}}var M="worldapp-admin-2026",L="worldapp.adminKey.v1",U="worldapp.insightsCronSecret.v1",X=Object.freeze({total:null,online:null}),Y=class a{constructor(t,e,r,n){this.countriesService=t;this.overridesService=e;this.route=r;this.router=n}locked=!0;keyInput="";keyError="";filter="";cronSecretInput="";cronRunning=!1;cronStatus="";countries=[];filteredCountries=[];overrides={};overrideCount=0;overridesSub;ngOnInit(){this.overrides=this.overridesService.getOverrides(),this.overrideCount=Object.keys(this.overrides).length,this.unlockFromStorage(),this.unlockFromQuery(),this.loadCronSecret(),this.overridesSub=this.overridesService.observe().subscribe(t=>{this.overrides=t||{},this.overrideCount=Object.keys(this.overrides).length,this.applyFilter()}),this.loadCountries()}ngOnDestroy(){this.overridesSub?.unsubscribe()}unlock(){let t=this.keyInput.trim();if(t){if(t!==M){this.keyError="Invalid key.";return}this.persistKey(t),this.locked=!1,this.keyError="",this.keyInput=""}}resetAll(){this.overridesService.clearAll()}applyFilter(){let t=this.filter.trim().toLowerCase(),e=this.countries;if(!t){this.filteredCountries=e;return}this.filteredCountries=e.filter(r=>{let n=r.name.toLowerCase(),s=(r.code||"").toLowerCase();return n.includes(t)||s.includes(t)})}overrideFor(t){let e=String(t??"").toUpperCase();return this.overrides[e]??X}setOverrideValue(t,e,r){let n=String(t??"").toUpperCase();if(!n)return;let s=this.overrides[n]??{},v=O(w({},s),{[e]:r});this.overridesService.setOverride(n,v)}clearOverride(t){let e=String(t??"").toUpperCase();e&&this.overridesService.setOverride(e,null)}goBack(){this.router.navigate(["/globe"])}async runDailyInsights(){let t=this.cronSecretInput.trim();if(!t){this.cronStatus="Enter the cron secret first.";return}this.persistCronSecret(t),this.cronRunning=!0,this.cronStatus="Running\u2026";try{let e=await fetch(`${R.apiBaseUrl}/insights/run-daily`,{method:"POST",headers:{"Content-Type":"application/json","x-cron-secret":t}}),r=await e.json().catch(()=>({}));if(!e.ok)this.cronStatus=`Failed: ${r?.error??e.status}`;else{let n=Number(r?.processed??0),s=Number(r?.failed??0);this.cronStatus=`Done. Countries: ${n}, Failed: ${s}`}}catch(e){this.cronStatus=`Failed: ${e?.message??"unknown error"}`}finally{this.cronRunning=!1}}async loadCountries(){try{let t=await this.countriesService.loadCountries();this.countries=t.countries.filter(e=>!!e.code),this.applyFilter()}catch{this.countries=[],this.filteredCountries=[]}}unlockFromQuery(){let t=this.route.snapshot.queryParamMap.get("key");t&&(t===M?(this.persistKey(t),this.locked=!1,this.keyError=""):this.keyError="Invalid key.")}unlockFromStorage(){try{localStorage.getItem(L)===M&&(this.locked=!1,this.keyError="")}catch{}}loadCronSecret(){try{let t=localStorage.getItem(U);t&&(this.cronSecretInput=t)}catch{}}persistKey(t){try{localStorage.setItem(L,t)}catch{}}persistCronSecret(t){try{localStorage.setItem(U,t)}catch{}}static \u0275fac=function(e){return new(e||a)(f(F),f(K),f(V),f(T))};static \u0275cmp=S({type:a,selectors:[["app-admin-presence-page"]],decls:4,vars:3,consts:[[1,"admin-shell"],["class","card lock-card",4,"ngIf"],["class","card",4,"ngIf"],["class","card cron-card",4,"ngIf"],[1,"card","lock-card"],[1,"card-title"],[1,"card-sub"],[1,"lock-row"],["type","password","placeholder","Admin key",3,"ngModelChange","keydown.enter","ngModel"],["type","button",3,"click"],["class","card-error",4,"ngIf"],[1,"card-error"],[1,"card"],[1,"card-head"],[1,"head-actions"],["type","button",1,"ghost",3,"click"],[1,"tools"],["type","text","placeholder","Filter countries",3,"ngModelChange","ngModel"],[1,"tools-meta"],[1,"grid-head"],["class","grid-row",4,"ngFor","ngForOf"],[1,"grid-row"],[1,"country-cell"],[1,"country-name"],[1,"country-code"],["type","number","min","0","step","1","placeholder","auto",3,"ngModelChange","ngModel"],[1,"card","cron-card"],[1,"cron-row"],["type","password","placeholder","Cron secret",3,"ngModelChange","ngModel"],["type","button",3,"click","disabled"],["class","card-sub",4,"ngIf"]],template:function(e,r){e&1&&(o(0,"div",0),x(1,$,13,2,"div",1)(2,q,27,3,"div",2)(3,J,12,4,"div",3),i()),e&2&&(d(),u("ngIf",r.locked),d(),u("ngIf",!r.locked),d(),u("ngIf",!r.locked))},dependencies:[A,E,I,B,D,z,N,W,j],styles:['[_nghost-%COMP%]{display:block;min-height:100vh;background:radial-gradient(circle at top,rgba(0,60,70,.28),transparent 60%),linear-gradient(180deg,#050a12,#071723);color:#e7f7ff;font-family:Sora,Space Grotesk,Avenir,sans-serif}.admin-shell[_ngcontent-%COMP%]{max-width:1100px;margin:0 auto;padding:36px 20px 72px}.card[_ngcontent-%COMP%]{background:#08121ceb;border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:22px;box-shadow:0 24px 60px #0006}.lock-card[_ngcontent-%COMP%]{max-width:520px;margin:12vh auto 0}.cron-card[_ngcontent-%COMP%]{margin-top:18px}.card-title[_ngcontent-%COMP%]{font-size:20px;font-weight:700;letter-spacing:.01em}.card-sub[_ngcontent-%COMP%]{margin-top:6px;opacity:.7;font-size:13px}.card-sub[_ngcontent-%COMP%]   code[_ngcontent-%COMP%]{background:#ffffff0f;padding:2px 6px;border-radius:6px}.lock-row[_ngcontent-%COMP%]{margin-top:18px;display:flex;gap:10px}input[type=text][_ngcontent-%COMP%], input[type=password][_ngcontent-%COMP%], input[type=number][_ngcontent-%COMP%]{border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#040a10e6;color:#e7f7ff;padding:10px 12px;font-size:13px;outline:none;width:100%;box-sizing:border-box}input[type=number][_ngcontent-%COMP%]{text-align:right}input[_ngcontent-%COMP%]:focus{border-color:#00ffd199;box-shadow:0 0 0 3px #00ffd11f}button[_ngcontent-%COMP%]{border-radius:12px;border:none;background:#00ffd12e;color:#c9fff2;padding:10px 14px;font-weight:700;cursor:pointer}button.ghost[_ngcontent-%COMP%]{background:#ffffff14;color:#fffc}.card-error[_ngcontent-%COMP%]{margin-top:12px;color:#ff9f9f;font-size:12px}.card-head[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:16px;align-items:flex-start;flex-wrap:wrap}.head-actions[_ngcontent-%COMP%]{display:flex;gap:8px}.tools[_ngcontent-%COMP%]{margin-top:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}.cron-row[_ngcontent-%COMP%]{margin-top:14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}.cron-row[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{flex:1 1 240px}.tools[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{max-width:320px}.tools-meta[_ngcontent-%COMP%]{opacity:.7;font-size:13px}.grid-head[_ngcontent-%COMP%], .grid-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:minmax(180px,1fr) 140px 140px 88px;gap:12px;align-items:center}.grid-head[_ngcontent-%COMP%]{margin-top:18px;padding-bottom:8px;font-size:11px;letter-spacing:.2em;opacity:.6}.grid-row[_ngcontent-%COMP%]{padding:10px 0;border-top:1px solid rgba(255,255,255,.06)}.country-cell[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:2px}.country-name[_ngcontent-%COMP%]{font-size:14px;font-weight:600}.country-code[_ngcontent-%COMP%]{font-size:11px;opacity:.6;letter-spacing:.2em}@media(max-width:720px){.grid-head[_ngcontent-%COMP%], .grid-row[_ngcontent-%COMP%]{grid-template-columns:1fr 1fr}.grid-head[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]:nth-child(3), .grid-head[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]:nth-child(4), .grid-row[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:nth-child(3), .grid-row[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{grid-column:span 1}.grid-row[_ngcontent-%COMP%]{grid-template-areas:"country country" "total online" "clear clear"}.grid-row[_ngcontent-%COMP%]   .country-cell[_ngcontent-%COMP%]{grid-area:country}.grid-row[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:nth-of-type(1){grid-area:total}.grid-row[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]:nth-of-type(2){grid-area:online}.grid-row[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{grid-area:clear;width:100%}.grid-head[_ngcontent-%COMP%]{display:none}}']})};export{Y as AdminPresencePageComponent};
