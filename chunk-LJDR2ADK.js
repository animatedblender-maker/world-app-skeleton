import{a as U}from"./chunk-AFJFBD4M.js";import{k,n as B}from"./chunk-SPQ2JWKS.js";var S="https://api.dicebear.com/7.x/identicon/svg?seed=",$="fake_users_60k_real_names/fake_users_60k.jsonl",x="names-by-country.json";function p(m){let t=m>>>0;return()=>{t|=0,t=t+1831565813|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}function y(m){let t=2166136261;for(let e=0;e<m.length;e++)t^=m.charCodeAt(e),t=Math.imul(t,16777619);return t>>>0}function d(m){return String(m||"").toLowerCase().replace(/[^a-z0-9._]/g,"").replace(/^@+/,"").slice(0,24)}function L(m,t,e){return Math.max(t,Math.min(e,m))}function A(m,t){let e=[],s=m.split(/\r?\n/);for(let i of s){let r=i.trim();if(r){try{e.push(JSON.parse(r))}catch{}if(t&&e.length>=t)break}}return e}var N=class m{constructor(t){this.countriesService=t}COUNT=3e4;initialized=!1;initPromise=null;profiles=[];profilesById=new Map;profilesByUsername=new Map;searchIndex=[];countries=[];fakeUsersLoaded=!1;fakeUsersPromise=null;fakeUsers=[];fakeUsersById=new Map;cityPoolByCountry=new Map;fallbackCityPoolByCountry=new Map;cityPrimaryCountry=new Map;generatedCityPoolByCountry=new Map;countryGeoByCode=new Map;namesLoaded=!1;namesPromise=null;namesByCountry={};async ensureInitialized(t){if(!this.initialized)return this.initPromise?this.initPromise:(this.initPromise=(async()=>{let e=(t||[]).filter(n=>!!n.code);if(e.length)this.countries=e;else{let n=await this.countriesService.loadCountries();this.countries=(n.countries||[]).filter(l=>!!l.code)}this.countries.length||(this.countries=[{id:0,name:"World",norm:"world",center:{lat:0,lng:0},labelSize:.6,flyAltitude:1,code:"WW",pointPool:[{lat:0,lng:0}]}]),this.buildCountryGeoIndex(),await this.loadFakeUsers(),await this.loadNamesByCountry(),this.buildCityPools();let s=Date.now(),i=1e3*60*60*24*365*2,r=new Set;this.profiles=[],this.profilesById.clear(),this.profilesByUsername.clear(),this.searchIndex=[];let o=this.fakeUsers.length?this.fakeUsers:[],a=L(this.COUNT,1,o.length||1);for(let n=0;n<a;n++){let l=o[n]||{user_id:`user_${String(n+1).padStart(6,"0")}`},c=String(l.user_id||"").trim()||`user_${String(n+1).padStart(6,"0")}`,h=p(y(c)),u=new Date(s-Math.floor(h()*i)).toISOString(),f=this.resolveCountryCode(l.country_code,l.country),g=this.buildUsername(l,c,f),w=this.buildDisplayName(l,c,g,f,r),M=this.resolveCountryName(l.country,f),P=this.pickCityName(l,f,c),_=this.normalizeBio(l.bio,l.city,P),b=p(y(`${c}|follow`)),z=Math.floor(Math.pow(b(),2)*2e4),I=Math.floor(Math.pow(b(),2)*3200),C={user_id:c,email:null,display_name:w,username:g,avatar_url:`${S}${encodeURIComponent(g||c)}`,country_name:M||"Unknown",country_code:f,city_name:P,bio:_,followers_count:z,following_count:I,created_at:u,updated_at:u};this.profiles.push(C),this.profilesById.set(c,C),g&&this.profilesByUsername.set(g.toLowerCase(),C);let v=d(l.handle||"");v&&this.profilesByUsername.set(v.toLowerCase(),C),this.searchIndex.push({profile:C,username:(g||"").toLowerCase(),display:(w||"").toLowerCase()})}this.initialized=!0})(),this.initPromise)}buildUsername(t,e,s){let i=d(t.username||t.handle||"");if(i)return i;let r=this.pickNamePart(t.first_name,s,"first",y(`${e}|first`)),o=this.pickNamePart(t.last_name,s,"last",y(`${e}|last`));return d(`${r}.${o}`)||d(e)||d(e)}buildDisplayName(t,e,s,i,r){let o=this.pickNamePart(t.first_name,i,"first",y(`${e}|first`)),a=this.pickNamePart(t.last_name,i,"last",y(`${e}|last`)),n=`${o} ${a}`.trim();n||(n=s||e);let l=0;for(;r.has(n)&&l<4;)n=`${n} ${String(l+1)}`.trim(),l+=1;return r.add(n),n}normalizeCountryCode(t){return String(t||"").trim().toUpperCase()||null}normalizeCountryName(t){return String(t||"").trim().toLowerCase().replace(/\s+/g," ")}buildCountryGeoIndex(){this.countryGeoByCode.clear();for(let t of this.countries){let e=String(t.code||"").trim().toUpperCase();if(!e)continue;let s=Array.isArray(t.pointPool)?t.pointPool:[];if(!s.length)continue;let i=1/0,r=-1/0,o=1/0,a=-1/0;for(let n of s)n&&(i=Math.min(i,n.lat),r=Math.max(r,n.lat),o=Math.min(o,n.lng),a=Math.max(a,n.lng));!Number.isFinite(i)||!Number.isFinite(o)||this.countryGeoByCode.set(e,{center:t.center,points:s,minLat:i,maxLat:r,minLng:o,maxLng:a})}}resolveCountryCode(t,e){let s=this.normalizeCountryCode(t);if(s)return s;let i=this.normalizeCountryName(e);return i?this.countries.find(o=>this.normalizeCountryName(o.name)===i)?.code??null:null}resolveCountryName(t,e){let s=(t||"").trim(),i=this.normalizeCountryName(s),r=String(e||"").trim().toUpperCase();if(r){let o=this.countries.find(a=>String(a.code||"").toUpperCase()===r);return o?i&&this.normalizeCountryName(o.name)===i?s:o.name||s||null:s||null}return s||null}pickNamePart(t,e,s,i){let r=this.getNameList(e,s);if(r.length){if(Number.isFinite(i)){let a=p(i);return r[Math.floor(a()*r.length)]}return r[0]}let o=(t||"").trim();return o||""}getNameList(t,e){let s=String(t??"").trim().toUpperCase(),i=s&&this.namesByCountry[s]?.[e]||[];if(i&&i.length)return i;let r=this.namesByCountry.GLOBAL?.[e]||[];return r&&r.length?r:[]}buildCityPools(){let t=new Map,e=new Map;for(let r of this.fakeUsers){let o=this.resolveCountryCode(r.country_code,r.country),a=this.normalizeCityName(r.city);if(!o||!a||!this.isSaneCityName(a))continue;let n=t.get(o)??new Map;n.set(a,(n.get(a)??0)+1),t.set(o,n);let l=e.get(a)??new Map;l.set(o,(l.get(o)??0)+1),e.set(a,l)}this.cityPoolByCountry.clear(),this.fallbackCityPoolByCountry.clear(),this.cityPrimaryCountry.clear(),this.generatedCityPoolByCountry.clear();let s=new Map;for(let[r,o]of e.entries()){let a=Array.from(o.entries()).sort((u,f)=>f[1]-u[1]),[n,l]=a[0],c=a.reduce((u,f)=>u+f[1],0),h=c?l/c:0;if(this.cityPrimaryCountry.set(r,n),c>=3&&h>=.7){let u=s.get(n)??[];u.push({city:r,count:l}),s.set(n,u)}}let i=240;for(let[r,o]of s.entries()){let a=o.sort((n,l)=>l.count-n.count).slice(0,i).map(n=>n.city);this.cityPoolByCountry.set(r,a)}for(let[r,o]of t.entries()){let a=Array.from(o.entries()).sort((n,l)=>l[1]-n[1]).slice(0,i).map(([n])=>n);this.fallbackCityPoolByCountry.set(r,a)}for(let r of this.countries){let o=String(r.code||"").trim().toUpperCase();if(!o)continue;let a=this.generateMapCityPool(o);a.length&&this.generatedCityPoolByCountry.set(o,a)}}pickCityName(t,e,s){let i=String(e||"").trim().toUpperCase(),r=this.normalizeCityName(t.city),o=i?this.generatedCityPoolByCountry.get(i)??[]:[],a=i?o.length?o:this.cityPoolByCountry.get(i)??this.fallbackCityPoolByCountry.get(i)??[]:[];if(!a.length)return null;let n=p(y(`${s}|city`));return a[Math.floor(n()*a.length)]??null}normalizeCityName(t){return String(t||"").trim().replace(/\s+/g," ")}isSaneCityName(t){if(!t)return!1;let e=t.trim();return!e||e.length>48?!1:(e.match(/[A-Za-z0-9 .,'-]/g)?.length??0)/e.length>=.7}generateMapCityPool(t){let e=this.countryGeoByCode.get(t);if(!e||!e.points.length)return[];let s=p(y(`${t}|geo`)),i=new Set,r=Math.min(e.points.length*2,480);for(let o=0;o<r;o+=1){let a=Math.floor(s()*e.points.length),n=e.points[a];if(n&&(i.add(this.pickRegionLabel(e,n)),i.size>=12))break}return Array.from(i)}pickRegionLabel(t,e){let s=Math.max(.1,t.maxLat-t.minLat),i=Math.max(.1,t.maxLng-t.minLng),r=(e.lat-t.center.lat)/s,o=(e.lng-t.center.lng)/i,a=.18,n="",l="";if(r>a?n="North":r<-a&&(n="South"),o>a?l="East":o<-a&&(l="West"),!n&&!l)return"Central";if(n&&l){let c=`${n}-${l}`;return{"North-East":"Northeast","North-West":"Northwest","South-East":"Southeast","South-West":"Southwest"}[c]??`${n}${l}`}return n||l}normalizeBio(t,e,s){let i=String(t||"").trim();if(!i)return null;let r=i,o=this.normalizeCityName(e),a=this.normalizeCityName(s);if(o){let n=o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(n,"gi");l.test(r)&&(r=r.replace(l,a||"").replace(/\s{2,}/g," ").trim())}return r=r.replace(/\s*(?:\u2022|\u00b7|[|.-])\s*$/g,"").trim(),r||null}async loadFakeUsers(){if(!this.fakeUsersLoaded)return this.fakeUsersPromise?this.fakeUsersPromise:(this.fakeUsersPromise=(async()=>{if(typeof window>"u"||typeof document>"u"){this.fakeUsers=[],this.fakeUsersLoaded=!0;return}try{let t=document.querySelector("base")?.getAttribute("href")??"/",e=new URL(t,window.location.origin).toString(),s=new URL($,e).toString(),i=await fetch(s);if(!i.ok)throw new Error(`Failed to load fake users: ${i.status}`);let r=await i.text();this.fakeUsers=A(r,this.COUNT),this.fakeUsersById.clear();for(let o of this.fakeUsers)o?.user_id&&this.fakeUsersById.set(o.user_id,o);this.buildCityPools()}catch{this.fakeUsers=[],this.fakeUsersById.clear(),this.cityPoolByCountry.clear(),this.fallbackCityPoolByCountry.clear(),this.cityPrimaryCountry.clear(),this.generatedCityPoolByCountry.clear()}finally{this.fakeUsersLoaded=!0}})(),this.fakeUsersPromise)}async loadNamesByCountry(){if(!this.namesLoaded)return this.namesPromise?this.namesPromise:(this.namesPromise=(async()=>{if(typeof window>"u"||typeof document>"u"){this.namesByCountry={},this.namesLoaded=!0;return}try{let t=document.querySelector("base")?.getAttribute("href")??"/",e=new URL(t,window.location.origin).toString(),s=new URL(x,e).toString(),i=await fetch(s);if(!i.ok)throw new Error(`Failed to load names data: ${i.status}`);let r=await i.json();this.namesByCountry=r&&typeof r=="object"?r:{}}catch{this.namesByCountry={}}finally{this.namesLoaded=!0}})(),this.namesPromise)}async getProfiles(t){return await this.ensureInitialized(t),this.profiles}async getProfileById(t){await this.ensureInitialized();let e=this.profilesById.get(t);if(e)return e;let s=this.fakeUsersById.get(t);if(!s)return null;let i=this.resolveCountryCode(s.country_code,s.country),r=this.buildUsername(s,t,i),o=this.buildDisplayName(s,t,r,i,new Set),a=this.resolveCountryName(s.country,i),n=this.pickCityName(s,i,t),l=new Date().toISOString(),c=this.normalizeBio(s.bio,s.city,n),h=p(y(`${t}|follow`)),u={user_id:t,email:null,display_name:o,username:r,avatar_url:`${S}${encodeURIComponent(r||t)}`,country_name:a||"Unknown",country_code:i,city_name:n,bio:c,followers_count:Math.floor(Math.pow(h(),2)*2e4),following_count:Math.floor(Math.pow(h(),2)*3200),created_at:l,updated_at:l};return this.profilesById.set(t,u),r&&this.profilesByUsername.set(r.toLowerCase(),u),this.searchIndex.push({profile:u,username:(r||"").toLowerCase(),display:(o||"").toLowerCase()}),this.profiles.push(u),u}async ensureProfilesById(t){await this.ensureInitialized();for(let e of t)!e||this.profilesById.has(e)||!this.fakeUsersById.get(e)||await this.getProfileById(e)}async getProfileByUsername(t){await this.ensureInitialized();let e=d(t);return e?this.profilesByUsername.get(e)??null:null}async getFollowCounts(t){await this.ensureInitialized();let e=this.profilesById.get(t);return e?{followers:e.followers_count??0,following:e.following_count??0}:null}async searchProfiles(t,e=6){await this.ensureInitialized();let s=String(t||"").trim().toLowerCase(),i=d(t);if(!s&&!i)return[];let r=[];for(let a of this.searchIndex){let n=-1;i&&a.username.startsWith(i)?n=0:s&&a.display.startsWith(s)?n=1:(i&&a.username.includes(i)||s&&a.display.includes(s))&&(n=2),n!==-1&&r.push({score:n,profile:a.profile,username:a.username})}r.sort((a,n)=>a.score-n.score||a.username.localeCompare(n.username));let o=[];for(let a of r)if(o.push(a.profile),o.length>=L(e,1,50))break;return o}static \u0275fac=function(e){return new(e||m)(B(U))};static \u0275prov=k({token:m,factory:m.\u0275fac,providedIn:"root"})};export{N as a};
