import{a as l}from"./chunk-LQQHCQP3.js";import{c as p}from"./chunk-KO5X6LCN.js";import{a as u,b as r,k as h,n as a,v as g}from"./chunk-SPQ2JWKS.js";import{a as d}from"./chunk-2NFLSA4Y.js";var S=class c{constructor(t,e){this.auth=t;this.zone=e;this.connect()}ws;connectedSubject=new r(!1);connected$=this.connectedSubject.asObservable();signalSubject=new u;signals$=this.signalSubject.asObservable();incomingSubject=new r(null);incoming$=this.incomingSubject.asObservable();destroyed=!1;get connected(){return this.connectedSubject.value}clearIncomingCall(){this.incomingSubject.next(null)}sendSignal(t,e,n){if(!e||!this.ws||this.ws.readyState!==WebSocket.OPEN)return;let i=d({type:t,conversationId:e},n??{});try{this.ws.send(JSON.stringify(i))}catch{}}async connect(){if(this.destroyed)return;let t=await this.auth.getAccessToken();if(!t){this.connectedSubject.next(!1),window.setTimeout(()=>void this.connect(),3e3);return}let e=l.apiBaseUrl||l.graphqlEndpoint.replace(/\/graphql$/,""),i=`${e.startsWith("https")?e.replace(/^https/,"wss"):e.replace(/^http/,"ws")}/ws?token=${encodeURIComponent(t)}`;if(this.ws&&this.ws.url===i&&this.ws.readyState<=WebSocket.OPEN)return;this.ws?.close();let s=new WebSocket(i);this.ws=s,s.onopen=()=>{this.zone.run(()=>this.connectedSubject.next(!0))},s.onmessage=o=>{this.handleMessage(String(o.data??""))},s.onclose=()=>{this.zone.run(()=>this.connectedSubject.next(!1)),this.ws=void 0,this.destroyed||window.setTimeout(()=>void this.connect(),3e3)},s.onerror=()=>{this.zone.run(()=>this.connectedSubject.next(!1))}}handleMessage(t){let e=null;try{e=JSON.parse(t)}catch{return}if(!e)return;let n=String(e?.type??""),i=String(e?.conversationId??""),s=String(e?.from??"");!n||!i||!s||this.zone.run(()=>{if(n==="call-offer"){let o=e.callType==="video"?"video":"audio",f=typeof e.callId=="string"?e.callId:void 0;this.incomingSubject.next({conversationId:i,from:s,callType:o,callId:f})}if(n==="call-end"||n==="call-decline"||n==="call-busy"){let o=this.incomingSubject.value;o&&o.conversationId===i&&this.incomingSubject.next(null)}this.signalSubject.next(e)})}static \u0275fac=function(e){return new(e||c)(a(p),a(g))};static \u0275prov=h({token:c,factory:c.\u0275fac,providedIn:"root"})};export{S as a};
