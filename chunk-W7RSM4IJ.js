import{a as U}from"./chunk-YQQ6SS3P.js";import{b as j}from"./chunk-JLBVTQ6O.js";import{a as z,b as D,e as L,o as B}from"./chunk-KSNNJYBO.js";import{a as q}from"./chunk-57X26VKZ.js";import{b as $}from"./chunk-YRPTNGKR.js";import"./chunk-YQ2TA2FF.js";import"./chunk-LJDR2ADK.js";import"./chunk-7DJA5TI4.js";import"./chunk-AFJFBD4M.js";import"./chunk-LQQHCQP3.js";import{c as R}from"./chunk-KO5X6LCN.js";import{C as v,D as o,Da as F,G as b,H as M,Ia as V,L as u,P as s,Q as r,R as a,S as x,V as w,W as S,Y as f,Z as m,_ as l,ea as C,fa as c,ga as P,ha as g,ja as k,ka as I,la as T,p as _,q as h,xa as O,ya as E}from"./chunk-SPQ2JWKS.js";import"./chunk-2NFLSA4Y.js";function H(n,t){if(n&1){let e=f();r(0,"button",13),m("click",function(){_(e);let p=l();return h(p.clearSearch())}),c(1,"x"),a()}}function A(n,t){n&1&&(r(0,"div",14),c(1," Start typing to search. "),a())}function W(n,t){n&1&&(r(0,"div",14),c(1," No results yet. "),a())}function G(n,t){n&1&&(r(0,"div",15),c(1,"Searching..."),a())}function J(n,t){if(n&1&&x(0,"img",33),n&2){let e=l().$implicit;s("src",e.author==null?null:e.author.avatar_url,v)}}function K(n,t){if(n&1&&(r(0,"span"),c(1),a()),n&2){let e=l().$implicit,i=l(2);o(),g(" ",i.initialsFor((e.author==null?null:e.author.display_name)||(e.author==null?null:e.author.username)||"U")," ")}}function Q(n,t){if(n&1){let e=f();r(0,"button",34),m("click",function(p){_(e);let d=l().$implicit,y=l(2);return h(y.toggleFollow(d.author_id,p))}),c(1),a()}if(n&2){let e=l().$implicit,i=l(2);C("following",i.isFollowing(e.author_id)),o(),g(" ",i.isFollowing(e.author_id)?"Following":"Follow"," ")}}function X(n,t){if(n&1&&(r(0,"div",35),c(1),a()),n&2){let e=l().$implicit;o(),g(" ",e.country_name," ")}}function Y(n,t){if(n&1&&(r(0,"div",36),c(1),a()),n&2){let e=l().$implicit;o(),P(e.body)}}function Z(n,t){if(n&1&&x(0,"img",40),n&2){let e=l(2).$implicit;s("src",e.media_url||e.thumb_url,v)}}function ee(n,t){if(n&1&&x(0,"img",41),n&2){let e=l(2).$implicit;s("src",e.thumb_url||e.media_url,v)}}function te(n,t){if(n&1&&(r(0,"div",37),u(1,Z,1,1,"img",38)(2,ee,1,1,"img",39),a()),n&2){let e=l().$implicit;o(),s("ngIf",e.media_type==="image"),o(),s("ngIf",e.media_type==="video")}}function ne(n,t){if(n&1){let e=f();r(0,"article",18)(1,"div",19)(2,"div",20),u(3,J,1,1,"img",21)(4,K,2,1,"span",12),a(),r(5,"div",22)(6,"div",23),c(7),a(),r(8,"div",24),c(9),a()(),u(10,Q,2,3,"button",25),a(),u(11,X,2,1,"div",26)(12,Y,2,1,"div",27)(13,te,3,2,"div",28),r(14,"div",29)(15,"button",30),m("click",function(p){let d=_(e).$implicit,y=l(2);return h(y.toggleLike(d,p))}),r(16,"span",31),c(17,"\u2764"),a(),r(18,"span"),c(19),a()(),r(20,"div",32),c(21),a()()()}if(n&2){let e=t.$implicit,i=l(2);o(3),s("ngIf",e.author==null?null:e.author.avatar_url),o(),s("ngIf",!(e.author!=null&&e.author.avatar_url)),o(3),P((e.author==null?null:e.author.display_name)||(e.author==null?null:e.author.username)||"Member"),o(2),g("@",(e.author==null?null:e.author.username)||(e.author==null?null:e.author.user_id)),o(),s("ngIf",i.canFollow(e)),o(),s("ngIf",e.country_name),o(),s("ngIf",e.body),o(),s("ngIf",e.media_type&&e.media_type!=="none"),o(2),C("liked",e.liked_by_me),o(4),P(e.like_count),o(2),g(" \u{1F4AC} ",e.comment_count," ")}}function ie(n,t){if(n&1){let e=f();r(0,"button",42),m("click",function(){_(e);let p=l(2);return h(p.loadMorePosts())}),c(1," Load more "),a()}}function oe(n,t){if(n&1&&(w(0),u(1,ne,22,12,"article",16)(2,ie,2,0,"button",17),S()),n&2){let e=l();o(),s("ngForOf",e.postResults)("ngForTrackBy",e.trackPost),o(),s("ngIf",e.canLoadMorePosts())}}function re(n,t){if(n&1&&x(0,"img",33),n&2){let e=l().$implicit;s("src",e.avatar_url,v)}}function ae(n,t){if(n&1&&(r(0,"span"),c(1),a()),n&2){let e=l().$implicit,i=l(2);o(),g(" ",i.initialsFor(e.display_name||e.username||"U")," ")}}function se(n,t){if(n&1){let e=f();r(0,"button",44),m("click",function(){let p=_(e).$implicit,d=l(2);return h(d.openProfile(p))}),r(1,"div",20),u(2,re,1,1,"img",21)(3,ae,2,1,"span",12),a(),r(4,"div",22)(5,"div",23),c(6),a(),r(7,"div",24),c(8),a()()()}if(n&2){let e=t.$implicit;o(2),s("ngIf",e.avatar_url),o(),s("ngIf",!e.avatar_url),o(3),P(e.display_name||e.username||"Member"),o(2),g("@",e.username||e.user_id)}}function le(n,t){if(n&1){let e=f();r(0,"button",42),m("click",function(){_(e);let p=l(2);return h(p.loadMorePeople())}),c(1," Load more "),a()}}function ce(n,t){if(n&1&&(w(0),u(1,se,9,4,"button",43)(2,le,2,0,"button",17),S()),n&2){let e=l();o(),s("ngForOf",e.peopleResults)("ngForTrackBy",e.trackProfile),o(),s("ngIf",e.canLoadMorePeople())}}var N=class n{constructor(t,e,i,p,d){this.posts=t;this.profiles=e;this.auth=i;this.follows=p;this.router=d}query="";activeTab="posts";isLoading=!1;postResults=[];peopleResults=[];postVisibleCount=40;peopleVisibleCount=40;hasMorePosts=!1;hasMorePeople=!1;searchSeq=0;meId=null;followingIds=new Set;followBusy=new Set;likeBusy=new Set;searchTimer=null;searchIdleHandle=null;ngOnInit(){this.loadFollowState()}ngOnDestroy(){this.searchTimer&&(clearTimeout(this.searchTimer),this.searchTimer=null)}setTab(t){this.activeTab!==t&&(this.activeTab=t,this.queueSearch())}clearSearch(){this.query="",this.postResults=[],this.peopleResults=[],this.postVisibleCount=40,this.peopleVisibleCount=40,this.hasMorePosts=!1,this.hasMorePeople=!1}queueSearch(){this.searchTimer&&clearTimeout(this.searchTimer),this.searchIdleHandle!==null&&"cancelIdleCallback"in window&&(window.cancelIdleCallback(this.searchIdleHandle),this.searchIdleHandle=null),this.searchTimer=setTimeout(()=>{"requestIdleCallback"in window?this.searchIdleHandle=window.requestIdleCallback(()=>{this.searchIdleHandle=null,this.runSearch()},{timeout:800}):this.runSearch()},360)}async runSearch(){let t=this.query.trim();if(!t||t.length<2){this.clearSearch();return}let e=++this.searchSeq;this.isLoading=!0;try{if(this.activeTab==="posts"){let i=this.postVisibleCount+1,p=await this.posts.searchPosts(t,i);if(e!==this.searchSeq)return;this.hasMorePosts=p.length>this.postVisibleCount,this.postResults=p.slice(0,this.postVisibleCount),this.peopleResults=[],this.hasMorePeople=!1}else if(this.activeTab==="people"){let i=this.peopleVisibleCount+1,p=await this.profiles.searchProfilesReal(t,i);if(e!==this.searchSeq)return;let d=p.searchProfiles??[];this.hasMorePeople=d.length>this.peopleVisibleCount,this.peopleResults=d.slice(0,this.peopleVisibleCount),this.postResults=[],this.hasMorePosts=!1}}catch{this.postResults=[],this.peopleResults=[],this.hasMorePosts=!1,this.hasMorePeople=!1}finally{this.isLoading=!1}}openPost(t){}openProfile(t){let e=t.username||t.user_id;e&&this.router.navigate(["/user",e])}hasResults(){return this.postResults.length>0||this.peopleResults.length>0}canLoadMorePosts(){return this.hasMorePosts}canLoadMorePeople(){return this.hasMorePeople}loadMorePosts(){this.postVisibleCount+=40,this.runSearch()}loadMorePeople(){this.peopleVisibleCount+=40,this.runSearch()}initialsFor(t){let e=String(t||"").trim();return e?e.slice(0,2).toUpperCase():"U"}trackPost(t,e){return e.id}trackProfile(t,e){return e.user_id}async loadFollowState(){try{let t=await this.auth.getUser();if(!t)return;this.meId=t.id;let e=await this.follows.listFollowingIds(t.id);this.followingIds=new Set(e??[])}catch{}}canFollow(t){return!this.meId||!t?.author_id?!1:t.author_id!==this.meId}isFollowing(t){return t?this.followingIds.has(t):!1}async toggleFollow(t,e){if(e?.stopPropagation(),!(!this.meId||!t)&&!this.followBusy.has(t)){this.followBusy.add(t);try{this.followingIds.has(t)?(await this.follows.unfollow(this.meId,t),this.followingIds.delete(t)):(await this.follows.follow(this.meId,t),this.followingIds.add(t))}finally{this.followBusy.delete(t)}}}async toggleLike(t,e){if(e?.stopPropagation(),!!t?.id&&!this.likeBusy.has(t.id)){this.likeBusy.add(t.id);try{let i=t.liked_by_me?await this.posts.unlikePost(t.id):await this.posts.likePost(t.id);Object.assign(t,i)}finally{this.likeBusy.delete(t.id)}}}static \u0275fac=function(e){return new(e||n)(b(j),b(q),b(R),b(U),b(V))};static \u0275cmp=M({type:n,selectors:[["app-search-page"]],decls:21,vars:11,consts:[[1,"search-page"],[1,"search-header"],[1,"search-title"],[1,"search-bar"],[1,"search-icon"],["type","text","name","search","autocomplete","off","placeholder","Search posts or people...",3,"ngModelChange","ngModel"],["type","button","class","clear-btn",3,"click",4,"ngIf"],[1,"search-tabs"],["type","button",1,"tab",3,"click"],[1,"search-results"],["class","empty-state",4,"ngIf"],["class","loader",4,"ngIf"],[4,"ngIf"],["type","button",1,"clear-btn",3,"click"],[1,"empty-state"],[1,"loader"],["class","post-card",4,"ngFor","ngForOf","ngForTrackBy"],["type","button","class","load-more",3,"click",4,"ngIf"],[1,"post-card"],[1,"post-header"],[1,"avatar"],["alt","avatar",3,"src",4,"ngIf"],[1,"meta"],[1,"name"],[1,"handle"],["class","follow-btn","type","button",3,"following","click",4,"ngIf"],["class","post-country",4,"ngIf"],["class","post-body",4,"ngIf"],["class","post-media",4,"ngIf"],[1,"post-actions"],["type","button",1,"action-btn",3,"click"],[1,"action-icon"],[1,"action-meta"],["alt","avatar",3,"src"],["type","button",1,"follow-btn",3,"click"],[1,"post-country"],[1,"post-body"],[1,"post-media"],["alt","Post media",3,"src",4,"ngIf"],["alt","Post video",3,"src",4,"ngIf"],["alt","Post media",3,"src"],["alt","Post video",3,"src"],["type","button",1,"load-more",3,"click"],["type","button","class","result-row",3,"click",4,"ngFor","ngForOf","ngForTrackBy"],["type","button",1,"result-row",3,"click"]],template:function(e,i){e&1&&(r(0,"div",0)(1,"header",1)(2,"div",2),c(3,"Search"),a(),r(4,"div",3)(5,"span",4),c(6,"\u{1F50D}"),a(),r(7,"input",5),T("ngModelChange",function(d){return I(i.query,d)||(i.query=d),d}),m("ngModelChange",function(){return i.queueSearch()}),a(),u(8,H,2,0,"button",6),a(),r(9,"div",7)(10,"button",8),m("click",function(){return i.setTab("posts")}),c(11," Posts "),a(),r(12,"button",8),m("click",function(){return i.setTab("people")}),c(13," People "),a()()(),r(14,"section",9),u(15,A,2,0,"div",10)(16,W,2,0,"div",10)(17,G,2,0,"div",11)(18,oe,3,3,"ng-container",12)(19,ce,3,3,"ng-container",12),a()(),x(20,"app-bottom-tabs")),e&2&&(o(7),k("ngModel",i.query),o(),s("ngIf",i.query),o(2),C("active",i.activeTab==="posts"),o(2),C("active",i.activeTab==="people"),o(3),s("ngIf",!i.query&&!i.isLoading),o(),s("ngIf",i.query&&!i.isLoading&&!i.hasResults()),o(),s("ngIf",i.isLoading),o(),s("ngIf",i.activeTab==="posts"),o(),s("ngIf",i.activeTab==="people"))},dependencies:[F,O,E,B,z,D,L,$],styles:["[_nghost-%COMP%]{display:block;min-height:100svh;background:var(--app-bg);color:#0a1220eb}.search-page[_ngcontent-%COMP%]{min-height:100svh;height:100svh;padding:calc(env(safe-area-inset-top) + 6px) 0 calc(var(--tabs-height, 64px) + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:0}.search-header[_ngcontent-%COMP%]{position:sticky;top:0;z-index:2;background:var(--app-bg);padding:12px 16px 10px;border-bottom:1px solid rgba(7,20,40,.08)}.search-title[_ngcontent-%COMP%]{font-weight:800;letter-spacing:.22em;text-transform:uppercase;font-size:11px;color:#091626a6;margin-bottom:8px}.search-bar[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid rgba(7,20,40,.12);border-radius:16px;padding:10px 12px;box-shadow:0 8px 24px #0a12200f}.search-bar[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{border:0;outline:none;background:transparent;flex:1;font-size:14px;color:inherit}.search-icon[_ngcontent-%COMP%]{font-size:16px;opacity:.7}.clear-btn[_ngcontent-%COMP%]{border:0;background:#0714281a;width:22px;height:22px;border-radius:50%;cursor:pointer;font-size:12px;color:#071428cc}.search-tabs[_ngcontent-%COMP%]{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}.search-tabs[_ngcontent-%COMP%]   .tab[_ngcontent-%COMP%]{border:1px solid transparent;border-radius:999px;padding:6px 12px;font-size:11px;font-weight:800;letter-spacing:.16em;text-transform:uppercase;background:#07142814;color:#071428d1;cursor:pointer}.search-tabs[_ngcontent-%COMP%]   .tab.active[_ngcontent-%COMP%]{border-color:#009bdc73;background:#009bdc24;color:#071428e6}.search-results[_ngcontent-%COMP%]{flex:1;overflow-y:auto;min-height:0;padding:14px 16px calc(var(--tabs-height, 64px) + env(safe-area-inset-bottom) + 28px);scroll-padding-bottom:calc(var(--tabs-height, 64px) + env(safe-area-inset-bottom) + 28px);display:flex;flex-direction:column;gap:14px;-webkit-overflow-scrolling:touch}.loader[_ngcontent-%COMP%], .empty-state[_ngcontent-%COMP%]{text-align:center;color:#0714288c;font-size:13px}.post-card[_ngcontent-%COMP%]{background:#fff;border-radius:18px;padding:14px;border:1px solid rgba(7,20,40,.08);box-shadow:0 10px 28px #0b132114;display:grid;gap:10px;cursor:pointer}.post-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px}.avatar[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:50%;background:#009bdc1f;display:grid;place-items:center;overflow:hidden;font-weight:800;color:#071428cc}.avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.meta[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{font-weight:800;font-size:14px}.meta[_ngcontent-%COMP%]   .handle[_ngcontent-%COMP%]{font-size:12px;color:#07142899}.post-body[_ngcontent-%COMP%]{font-size:14px;color:#071428d9}.post-media[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;border-radius:14px;display:block;background:#0b0f16}.post-country[_ngcontent-%COMP%]{font-size:12px;color:#0714288c;text-transform:uppercase;letter-spacing:.18em;font-weight:700}.post-actions[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:12px;padding-top:4px}.action-btn[_ngcontent-%COMP%]{border:0;background:transparent;display:inline-flex;align-items:center;gap:6px;font-weight:700;color:#071428b3;cursor:pointer}.action-btn[_ngcontent-%COMP%]   .action-icon[_ngcontent-%COMP%]{font-size:16px;line-height:1}.action-btn.liked[_ngcontent-%COMP%]{color:#d2304e}.action-meta[_ngcontent-%COMP%]{font-size:12px;color:#07142899;font-weight:600}.follow-btn[_ngcontent-%COMP%]{margin-left:auto;border:1px solid rgba(0,155,220,.4);background:#009bdc1f;color:#071428e6;border-radius:999px;padding:6px 12px;font-size:11px;font-weight:800;letter-spacing:.12em;text-transform:uppercase;cursor:pointer}.follow-btn.following[_ngcontent-%COMP%]{background:#07142814;border-color:#0714282e;color:#071428b3}.result-row[_ngcontent-%COMP%]{border:1px solid rgba(7,20,40,.08);background:#fff;border-radius:16px;padding:12px 14px;display:flex;align-items:center;gap:12px;cursor:pointer;text-align:left;box-shadow:0 10px 28px #0b132114}.load-more[_ngcontent-%COMP%]{border:1px solid rgba(0,155,220,.3);background:#009bdc14;color:#071428d1;border-radius:999px;padding:8px 14px;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;cursor:pointer;justify-self:center}"]})};export{N as SearchPageComponent};
