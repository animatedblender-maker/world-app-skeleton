import{a as v}from"./chunk-VEHW3HLT.js";import{a as y}from"./chunk-LJDR2ADK.js";import{b as h}from"./chunk-KO5X6LCN.js";import{k as p,n as d}from"./chunk-SPQ2JWKS.js";import{a as m}from"./chunk-2NFLSA4Y.js";function b(u){if(!Number.isFinite(u))return 0;let e=u;for(;e>180;)e-=360;for(;e<-180;)e+=360;return e}function g(u,e,t){return Math.max(e,Math.min(t,u))}function _(u){let e=u>>>0;return()=>{e|=0,e=e+1831565813|0;let t=Math.imul(e^e>>>15,1|e);return t=t+Math.imul(t^t>>>7,61|t)^t,((t^t>>>14)>>>0)/4294967296}}var C=class u{constructor(e,t){this.fakeData=e;this.overridesService=t}countries=[];channel=null;profilesById=new Map;fakeProfiles=[];fakeOnlineIds=[];fakeOnlinePoints=[];fakeOnlineByCountry={};overridesByCountry={};overridesSub=null;onlineMetaById=new Map;onUpdateCb=null;onHeartbeatCb=null;meId=null;currentCountryCode=null;currentCountryName=null;currentCityName=null;renderTimer=null;RENDER_MS=800;refreshProfilesTimer=null;PROFILES_REFRESH_MS=12e4;fakeOnlineTimer=null;FAKE_ONLINE_REFRESH_MS=3e4;FAKE_ONLINE_MIN=.4;FAKE_ONLINE_MAX=.65;FAKE_ONLINE_WAVE_SECONDS=180;MAX_FAKE_POINTS=3500;MAX_TOTAL_POINTS=4200;baseTotalsByCountry={};baseTotalUsers=0;DOT_COLOR="rgba(0,255,209,0.92)";async start(e){this.stop(),this.countries=e.countries||[],this.onUpdateCb=e.onUpdate,this.onHeartbeatCb=e.onHeartbeat??null;let{data:t}=await h.auth.getUser();this.meId=t.user?.id??null,this.currentCountryCode=e.meCountryCode??null,this.currentCountryName=e.meCountryName??null,this.currentCityName=e.meCityName??null,await this.fakeData.ensureInitialized(this.countries),e.loadProfiles!==!1?await this.fetchAllProfiles():(this.profilesById.clear(),await this.injectFakeProfiles()),await this.startRealtimePresence(),this.startFakeOnline(),this.startOverridesWatcher(),this.renderTimer=setInterval(()=>this.emit(),this.RENDER_MS),this.refreshProfilesTimer=setInterval(()=>{this.fetchAllProfiles().then(()=>this.emit()).catch(()=>{})},this.PROFILES_REFRESH_MS),this.emit()}stop(){this.renderTimer&&clearInterval(this.renderTimer),this.renderTimer=null,this.refreshProfilesTimer&&clearInterval(this.refreshProfilesTimer),this.refreshProfilesTimer=null,this.fakeOnlineTimer&&clearInterval(this.fakeOnlineTimer),this.fakeOnlineTimer=null;try{this.channel&&h.removeChannel(this.channel)}catch{}this.channel=null,this.onUpdateCb=null,this.onHeartbeatCb=null,this.onlineMetaById.clear(),this.fakeOnlineIds=[],this.fakeOnlinePoints=[],this.fakeOnlineByCountry={},this.overridesByCountry={},this.overridesSub&&(this.overridesSub.unsubscribe(),this.overridesSub=null)}async setMyLocation(e,t,n){this.currentCountryCode=e??null,this.currentCountryName=t??null,this.currentCityName=n??null,await this.trackMe(),this.emit()}async fetchAllProfiles(){let e=[];try{let{data:t,error:n}=await h.from("profiles").select("user_id,country_code,country_name,city_name");!n&&t&&(e=t)}catch{}this.profilesById.clear();for(let t of e)t?.user_id&&this.profilesById.set(t.user_id,t);await this.injectFakeProfiles()}async injectFakeProfiles(){this.fakeProfiles=await this.fakeData.getProfiles(this.countries);for(let e of this.fakeProfiles)e?.user_id&&this.profilesById.set(e.user_id,{user_id:e.user_id,country_code:e.country_code??null,country_name:e.country_name??null,city_name:e.city_name??null});this.rebuildTotalsCache()}rebuildTotalsCache(){let e={};for(let[,t]of this.profilesById.entries()){let n=String(t.country_code??"").trim().toUpperCase();n&&(e[n]=(e[n]??0)+1)}this.baseTotalsByCountry=e,this.baseTotalUsers=this.profilesById.size}startFakeOnline(){this.fakeOnlineTimer||(this.refreshFakeOnline(),this.fakeOnlineTimer=setInterval(()=>{this.refreshFakeOnline()},this.FAKE_ONLINE_REFRESH_MS))}computeFakeOnlineRatio(){let e=Date.now(),t=e/1e3*(2*Math.PI/this.FAKE_ONLINE_WAVE_SECONDS),n=(Math.sin(t)+1)/2,l=this.FAKE_ONLINE_MIN+(this.FAKE_ONLINE_MAX-this.FAKE_ONLINE_MIN)*n,c=Math.floor(e/6e4)+77,r=(_(c)()-.5)*.05;return g(l+r,this.FAKE_ONLINE_MIN,this.FAKE_ONLINE_MAX)}async refreshFakeOnline(){if(this.fakeProfiles.length||await this.injectFakeProfiles(),!this.fakeProfiles.length)return;let e=this.computeFakeOnlineRatio(),t=Math.floor(Date.now()/this.FAKE_ONLINE_REFRESH_MS)+911,n=_(t),l=[],c=[],r={};for(let i of this.fakeProfiles){if(n()>e)continue;let s=String(i.country_code??"").trim().toUpperCase();if(!s)continue;let a=this.countryForCode(s);if(!a)continue;l.push(i.user_id),r[s]=(r[s]??0)+1;let o=this.approximatePoint(a,i.user_id,i.city_name??null);c.push({id:i.user_id,lat:o.lat,lng:o.lng,cc:s,color:this.DOT_COLOR,radius:1.4})}if(!l.length){let i=this.fakeProfiles[0];if(i?.country_code){let s=String(i.country_code).trim().toUpperCase(),a=this.countryForCode(s);if(a){l.push(i.user_id),r[s]=1;let o=this.approximatePoint(a,i.user_id,i.city_name??null);c.push({id:i.user_id,lat:o.lat,lng:o.lng,cc:s,color:this.DOT_COLOR,radius:1.4})}}}if(c.length>this.MAX_FAKE_POINTS){let i=Math.ceil(c.length/this.MAX_FAKE_POINTS),s=[];for(let a=0;a<c.length;a+=i)s.push(c[a]);this.fakeOnlinePoints=s}else this.fakeOnlinePoints=c;this.fakeOnlineIds=l,this.fakeOnlineByCountry=r,this.emit()}async startRealtimePresence(){if(!this.meId){this.onHeartbeatCb?.("presence: no user session");return}this.channel=h.channel("worldapp-online",{config:{presence:{key:this.meId}}}),this.channel.on("presence",{event:"sync"},()=>{this.rebuildOnlineMapFromState(),this.onHeartbeatCb?.("presence: sync \u2713"),this.emit()}).on("presence",{event:"join"},()=>{this.rebuildOnlineMapFromState(),this.onHeartbeatCb?.("presence: join \u2713"),this.emit()}).on("presence",{event:"leave"},()=>{this.rebuildOnlineMapFromState(),this.onHeartbeatCb?.("presence: leave \u2713"),this.emit()});let{error:e}=await this.channel.subscribe(async t=>{this.onHeartbeatCb?.(`presence: ${String(t)}`),t==="SUBSCRIBED"&&(await this.trackMe(),this.rebuildOnlineMapFromState(),this.emit())});if(e)throw e}async trackMe(){if(!this.channel||!this.meId)return;let e=this.profilesById.get(this.meId),t={user_id:this.meId,country_code:this.currentCountryCode??e?.country_code??null,country_name:this.currentCountryName??e?.country_name??null,city_name:this.currentCityName??null,ts:Date.now()};await this.channel.track(t)}rebuildOnlineMapFromState(){if(!this.channel)return;let e=this.channel.presenceState?.()??{};this.onlineMetaById.clear();for(let t of Object.keys(e)){let n=Array.isArray(e[t])?e[t]:[];if(!n.length)continue;let l=n[0];for(let r of n)(r?.ts??0)>(l?.ts??0)&&(l=r);let c=String(l.user_id??t);this.onlineMetaById.set(c,l)}}emit(){if(!this.onUpdateCb)return;let e={};for(let[r,i]of Object.entries(this.baseTotalsByCountry))e[r]={total:i,online:0};for(let[r,i]of Object.entries(this.fakeOnlineByCountry))e[r]??={total:0,online:0},e[r].online+=i;let t=[...this.fakeOnlineIds],n=[...this.fakeOnlinePoints];for(let r of this.onlineMetaById.keys()){let i=this.onlineMetaById.get(r),s=this.profilesById.get(r),a=String(i?.country_code??s?.country_code??"").trim().toUpperCase();if(!a)continue;let o=this.countryForCode(a);if(!o)continue;e[a]??={total:0,online:0},e[a].online+=1;let O=i?.city_name??s?.city_name??null,f=this.approximatePoint(o,r,O);n.push({id:r,lat:f.lat,lng:f.lng,cc:a,color:this.DOT_COLOR,radius:1.6}),t.push(r)}let l=this.baseTotalUsers||this.profilesById.size,c=t.length;for(let[r,i]of Object.entries(this.overridesByCountry)){let s=String(r??"").trim().toUpperCase();if(!s)continue;let a=e[s]??{total:0,online:0},o=m({},a);Number.isFinite(i?.total)&&(l+=i.total-a.total,o.total=i.total),Number.isFinite(i?.online)&&(c+=i.online-a.online,o.online=i.online),Number.isFinite(o.total)&&Number.isFinite(o.online)&&o.online>o.total&&(c-=o.online-o.total,o.online=o.total),e[s]=o}if(n.length>this.MAX_TOTAL_POINTS){let r=Math.ceil(n.length/this.MAX_TOTAL_POINTS);n=n.filter((i,s)=>s%r===0)}this.onUpdateCb({points:n,onlineIds:t,totalUsers:l,onlineUsers:c,byCountry:e})}startOverridesWatcher(){this.overridesSub||(this.overridesByCountry=this.overridesService.getOverrides(),this.overridesSub=this.overridesService.observe().subscribe(e=>{this.overridesByCountry=e||{},this.emit()}))}countryForCode(e){let t=String(e??"").trim().toUpperCase();return t&&this.countries.find(n=>String(n.code??"").toUpperCase()===t)||null}approximatePoint(e,t,n){let l=e.pointPool||[];if(!l.length)return{lat:e.center.lat,lng:b(e.center.lng)};let c=this.hash(`${t}|${e.code??e.name}|${n??""}`),r=Math.abs(c)%l.length,i=l[r];return{lat:i.lat,lng:b(i.lng)}}hash(e){let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,16777619);return Math.abs(t)}static \u0275fac=function(t){return new(t||u)(d(y),d(v))};static \u0275prov=p({token:u,factory:u.\u0275fac,providedIn:"root"})};export{C as a};
