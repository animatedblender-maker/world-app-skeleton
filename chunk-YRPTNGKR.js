import{a as I}from"./chunk-YQ2TA2FF.js";import{a as D}from"./chunk-7DJA5TI4.js";import{c as w}from"./chunk-KO5X6LCN.js";import{D as r,Da as T,Fa as _,G as c,Ga as P,H as f,Ia as L,L as v,P as y,Q as n,R as s,Z as u,_ as C,ea as l,fa as d,ga as x,k as g,n as b,ya as S}from"./chunk-SPQ2JWKS.js";var U=`
mutation DetectLocation($lat: Float!, $lng: Float!) {
  detectLocation(lat: $lat, lng: $lng) {
    countryCode
    countryName
    cityName
    source
  }
}
`,p=class a{constructor(t){this.gql=t}async detectViaGpsThenServer(t=8e3){let e=this.getCachedLocation(),i=await this.getBrowserCoords(t);if(!i)return e;try{let o=await this.gql.request(U,{lat:i.lat,lng:i.lng});return o.detectLocation?.countryCode&&o.detectLocation?.countryName&&this.setCachedLocation(o.detectLocation),o.detectLocation??e}catch{return e}}getBrowserCoords(t){return new Promise(e=>{if(!("geolocation"in navigator))return e(null);let i=!1,o=m=>{i||(i=!0,e(m))},h=window.setTimeout(()=>o(null),t);navigator.geolocation.getCurrentPosition(m=>{clearTimeout(h),o({lat:m.coords.latitude,lng:m.coords.longitude})},()=>{clearTimeout(h),o(null)},{enableHighAccuracy:!1,timeout:t,maximumAge:6e4})})}getCachedLocation(){try{let t=localStorage.getItem("matterya:lastLocation");if(!t)return null;let e=JSON.parse(t);return!e?.countryCode||!e?.countryName?null:e}catch{return null}}cacheLocation(t){!t?.countryCode||!t?.countryName||this.setCachedLocation(t)}setCachedLocation(t){try{localStorage.setItem("matterya:lastLocation",JSON.stringify(t))}catch{}}static \u0275fac=function(e){return new(e||a)(b(D))};static \u0275prov=g({token:a,factory:a.\u0275fac,providedIn:"root"})};function N(a,t){if(a&1&&(n(0,"span",7),d(1),s()),a&2){let e=C();r(),x(e.messagesUnreadCount)}}var M=class a{constructor(t,e,i,o,h){this.router=t;this.route=e;this.location=i;this.auth=o;this.notifications=h}active="home";messagesUnreadCount=0;tabsHidden=!1;sub;lastGlobeUrl="/globe";unreadPollTimer=null;unreadRefreshInFlight=!1;lastScrollTop=0;scrollHandler=t=>this.handleScroll(t);ngOnInit(){this.syncActive(this.router.url),this.captureGlobeUrl(this.router.url),this.sub=this.router.events.subscribe(t=>{if(t instanceof _){let e=t.urlAfterRedirects||t.url;this.syncActive(e),this.captureGlobeUrl(e)}}),this.refreshUnreadMessages(),this.unreadPollTimer=window.setInterval(()=>this.refreshUnreadMessages(),2e4),window.addEventListener("scroll",this.scrollHandler,!0)}ngOnDestroy(){this.sub?.unsubscribe(),this.unreadPollTimer&&(window.clearInterval(this.unreadPollTimer),this.unreadPollTimer=null),window.removeEventListener("scroll",this.scrollHandler,!0)}goHome(){if(this.lastGlobeUrl){this.router.navigateByUrl(this.lastGlobeUrl);return}let e=this.location.getCachedLocation()?.countryCode?.trim().toUpperCase();this.router.navigate(["/globe"],{queryParams:e?{country:e,tab:"posts",panel:null}:null})}openSearch(){this.active!=="search"&&this.router.navigate(["/search"])}goMessages(){this.active!=="messages"&&this.router.navigate(["/messages"])}goProfile(){this.active!=="profile"&&this.router.navigate(["/me"])}async refreshUnreadMessages(){if(!this.unreadRefreshInFlight){this.unreadRefreshInFlight=!0;try{if(!await this.auth.getUser()){this.messagesUnreadCount=0;return}let{notifications:e}=await this.notifications.list(80),i=(e??[]).filter(o=>!o.read_at&&String(o?.type??"").toLowerCase()==="message");this.messagesUnreadCount=i.length}catch{}finally{this.unreadRefreshInFlight=!1}}}syncActive(t){if(t.startsWith("/messages")){this.active="messages";return}if(t.startsWith("/me")){this.active="profile";return}if(t.startsWith("/user")){this.active="home";return}if(t.startsWith("/globe")||t==="/"||t.startsWith("/globe-cesium")){this.active="home";return}if(t.startsWith("/search")){this.active="search";return}this.active="home"}captureGlobeUrl(t){(t.startsWith("/globe")||t==="/"||t.startsWith("/globe-cesium"))&&(this.lastGlobeUrl=this.stripSearchParam(t))}stripSearchParam(t){try{let e=new URL(t,window.location.origin);return e.searchParams.delete("search"),e.pathname+(e.search?e.search:"")}catch{return t.replace(/([?&])search=[^&]+/,"").replace(/[?&]$/,"")}}handleScroll(t){let e=t.target,i=0;e&&e.scrollTop!=null?i=e.scrollTop:i=window.scrollY||document.documentElement.scrollTop||0;let o=i-this.lastScrollTop;Math.abs(o)<6||(o>0&&i>20?this.tabsHidden=!0:o<0&&(this.tabsHidden=!1),this.lastScrollTop=i)}static \u0275fac=function(e){return new(e||a)(c(L),c(P),c(p),c(w),c(I))};static \u0275cmp=f({type:a,selectors:[["app-bottom-tabs"]],hostVars:2,hostBindings:function(e,i){e&2&&l("hidden",i.tabsHidden)},decls:14,vars:9,consts:[["role","navigation","aria-label","Primary",1,"bottom-tabs"],["type","button","aria-label","Feed",1,"tab-btn",3,"click"],["aria-hidden","true",1,"tab-icon"],["type","button","aria-label","Search",1,"tab-btn",3,"click"],["type","button","aria-label","Chats",1,"tab-btn",3,"click"],["class","tab-badge",4,"ngIf"],["type","button","aria-label","Profile",1,"tab-btn",3,"click"],[1,"tab-badge"]],template:function(e,i){e&1&&(n(0,"nav",0)(1,"button",1),u("click",function(){return i.goHome()}),n(2,"span",2),d(3,"\u{1F3E0}"),s()(),n(4,"button",3),u("click",function(){return i.openSearch()}),n(5,"span",2),d(6,"\u{1F50D}"),s()(),n(7,"button",4),u("click",function(){return i.goMessages()}),n(8,"span",2),d(9,"\u{1F4AC}"),s(),v(10,N,2,1,"span",5),s(),n(11,"button",6),u("click",function(){return i.goProfile()}),n(12,"span",2),d(13,"\u{1F464}"),s()()()),e&2&&(r(),l("active",i.active==="home"),r(3),l("active",i.active==="search"),r(3),l("active",i.active==="messages"),r(3),y("ngIf",i.messagesUnreadCount>0),r(),l("active",i.active==="profile"))},dependencies:[T,S],styles:["[_nghost-%COMP%]{position:fixed;left:0;right:0;bottom:0;z-index:90;pointer-events:none;transition:transform .18s ease,opacity .18s ease}.hidden[_nghost-%COMP%]{transform:translateY(calc(var(--tabs-height, 64px) + env(safe-area-inset-bottom) + 6px));opacity:0}.bottom-tabs[_ngcontent-%COMP%]{pointer-events:auto;display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;padding:6px 12px calc(8px + env(safe-area-inset-bottom));height:calc(var(--tabs-height, 64px) + env(safe-area-inset-bottom));background:#fff;border-top:1px solid rgba(7,20,40,.08);box-shadow:0 -6px 20px #0c121814}.tab-btn[_ngcontent-%COMP%]{border:0;border-radius:14px;background:transparent;color:#0d1624b3;cursor:pointer;padding:6px 4px;transition:color .12s ease;position:relative;display:grid;place-items:center;gap:4px}.tab-btn[_ngcontent-%COMP%]:hover{color:#101724}.tab-btn.active[_ngcontent-%COMP%]{color:#0b1a2c}.tab-icon[_ngcontent-%COMP%]{font-size:20px;line-height:1}.tab-label[_ngcontent-%COMP%]{display:none}.tab-badge[_ngcontent-%COMP%]{position:absolute;top:2px;right:10px;min-width:18px;height:18px;border-radius:999px;background:#389efff2;color:#041629;font-size:10px;font-weight:900;display:grid;place-items:center;padding:0 6px;box-shadow:0 0 0 2px #060a10cc}@media(max-width:640px){.tab-icon[_ngcontent-%COMP%]{font-size:18px}.tab-badge[_ngcontent-%COMP%]{top:2px;right:6px;min-width:16px;height:16px;font-size:9px}}"]})};export{p as a,M as b};
