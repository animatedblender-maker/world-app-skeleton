import{a as B}from"./chunk-S7D4WX2P.js";import{a as j}from"./chunk-5HBUYTZB.js";import{a as V}from"./chunk-57X26VKZ.js";import{a as L}from"./chunk-YQ2TA2FF.js";import"./chunk-LJDR2ADK.js";import"./chunk-7DJA5TI4.js";import"./chunk-AFJFBD4M.js";import"./chunk-LQQHCQP3.js";import{c as S}from"./chunk-KO5X6LCN.js";import{D as u,Da as T,Ea as N,Fa as E,G as h,H as U,Ha as W,Ia as P,Ja as F,L as R,P as C,Q as c,R as m,S as k,Y as _,Z as x,_ as p,fa as f,h as A,ha as M,o as y,p as b,q as v,ya as O}from"./chunk-SPQ2JWKS.js";import"./chunk-2NFLSA4Y.js";var l=async(e,i)=>{let t=y(S),o=y(V),n=y(P),a=i.url||"/";if(a.startsWith("/auth")||a.startsWith("/reset-password"))return!0;let r=await t.getUser();if(!r)return n.parseUrl("/auth");if(a.startsWith("/profile-setup"))return!0;try{let{meProfile:s}=await o.meProfile();return s||!s&&(await o.profileById(r.id)).profileById?!0:n.parseUrl("/profile-setup")}catch(s){return console.warn("[authGuard] meProfile failed, allowing navigation:",s),!0}return!0};var z=[{path:"auth",loadComponent:()=>import("./chunk-HGE54XUS.js").then(e=>e.AuthPageComponent)},{path:"profile-setup",canActivate:[l],loadComponent:()=>import("./chunk-CALE2HXL.js").then(e=>e.ProfileSetupPageComponent)},{path:"reset-password",loadComponent:()=>import("./chunk-AA67OQ7C.js").then(e=>e.ResetPasswordPageComponent)},{path:"me",canActivate:[l],loadComponent:()=>import("./chunk-647VRXU4.js").then(e=>e.MePageComponent)},{path:"",canActivate:[l],loadComponent:()=>import("./chunk-PSNBEHQ6.js").then(e=>e.GlobePageComponent)},{path:"globe",canActivate:[l],loadComponent:()=>import("./chunk-PSNBEHQ6.js").then(e=>e.GlobePageComponent)},{path:"globe-cesium",canActivate:[l],loadComponent:()=>import("./chunk-2J7NM7CM.js").then(e=>e.GlobeCesiumPageComponent)},{path:"messages",canActivate:[l],loadComponent:()=>import("./chunk-6OR6CREL.js").then(e=>e.MessagesPageComponent)},{path:"search",canActivate:[l],loadComponent:()=>import("./chunk-W7RSM4IJ.js").then(e=>e.SearchPageComponent)},{path:"reels/:country",canActivate:[l],loadComponent:()=>import("./chunk-OGAR2XB4.js").then(e=>e.ReelsPageComponent)},{path:"post/:id",loadComponent:()=>import("./chunk-5RIZHJOK.js").then(e=>e.PostPageComponent)},{path:"ops-portal-2026",canActivate:[l],loadComponent:()=>import("./chunk-CBWYMTDG.js").then(e=>e.AdminPresencePageComponent)},{path:"admin-presence",canActivate:[l],loadComponent:()=>import("./chunk-CBWYMTDG.js").then(e=>e.AdminPresencePageComponent)},{path:"user/:slug",loadComponent:()=>import("./chunk-HNCSKXM4.js").then(e=>e.ProfilePageComponent)},{path:"**",redirectTo:""}];function q(e,i){if(e&1&&(c(0,"span",6),f(1),m()),e&2){let t=p(2);u(),M(" ",t.notificationsUnreadCount," ")}}function D(e,i){if(e&1){let t=_();c(0,"button",3),x("click",function(){b(t);let n=p();return v(n.openNotifications())}),k(1,"img",4),R(2,q,2,1,"span",5),m()}if(e&2){let t=p();u(2),C("ngIf",t.notificationsUnreadCount>0)}}function H(e,i){if(e&1){let t=_();c(0,"button",7),x("click",function(){b(t);let n=p();return v(n.openTravelSearch())}),c(1,"span",8),f(2,"\u2708"),m()()}}function $(e,i){if(e&1){let t=_();c(0,"div",9)(1,"div",10)(2,"div",11),f(3),m(),c(4,"div",12)(5,"button",13),x("click",function(){b(t);let n=p();return v(n.acceptCall())}),f(6,"Accept"),m(),c(7,"button",14),x("click",function(){b(t);let n=p();return v(n.declineCall())}),f(8,"Decline"),m()()()()}if(e&2){let t=p();u(3),M(" Incoming ",t.incomingCall.callType==="video"?"video":"voice"," call ")}}var I=class e{constructor(i,t,o,n,a){this.callService=i;this.router=t;this.auth=o;this.notifications=n;this.notificationEvents=a;this.checkForAppUpdate();let r=new URLSearchParams(window.location.search).get("redirect");if(r)try{window.history.replaceState(null,"",r),this.router.navigateByUrl(r)}catch{}this.callService.incoming$.subscribe(s=>{this.incomingCall=s}),this.updateRouteFlags(this.router.url),this.syncRootBackground(this.router.url),this.router.events.pipe(A(s=>s instanceof E)).subscribe(()=>{this.updateRouteFlags(this.router.url),this.syncRootBackground(this.router.url)}),this.initNotificationBadge()}incomingCall=null;isMessagesRoute=!1;isProfileRoute=!1;isReelsRoute=!1;showTravelButton=!1;notificationsUnreadCount=0;notificationInsertSub;notificationUpdateSub;notificationPollTimer=null;notificationsRefreshInFlight=!1;meId=null;updateRouteFlags(i){this.isMessagesRoute=i.startsWith("/messages"),this.isProfileRoute=i.startsWith("/me")||i.startsWith("/user"),this.isReelsRoute=i.startsWith("/reels");let t=null;try{t=new URL(i,window.location.origin)}catch{}let o=t?.pathname??i,n=o==="/"||o.startsWith("/globe")||o.startsWith("/globe-cesium"),a=!!t?.searchParams?.get("country");this.showTravelButton=n&&!a}syncRootBackground(i){if(typeof document>"u")return;let t=document.documentElement;t.classList.remove("app-bg-globe","app-bg-feed","app-bg-light");let o=document.querySelector('meta[name="theme-color"]'),n=d=>{o&&o.setAttribute("content",d),document.body.style.backgroundColor=d,document.documentElement.style.backgroundColor=d},a=null;try{a=new URL(i,window.location.origin)}catch{}let r=a?.pathname??i,s=r.startsWith("/globe")||r==="/"||r.startsWith("/globe-cesium"),g=r.startsWith("/reels");if(s&&!!a?.searchParams?.get("country")){t.classList.add("app-bg-feed");let d=getComputedStyle(t).getPropertyValue("--app-bg").trim();n(d||"#f5f6f8");return}if(s||g){t.classList.add("app-bg-globe");let d=getComputedStyle(t).getPropertyValue("--app-bg").trim();n(d||"#05070b");return}t.classList.add("app-bg-light");let G=getComputedStyle(t).getPropertyValue("--app-bg").trim();n(G||"#f5f6f8")}openTravelSearch(){this.router.navigate(["/globe"],{queryParams:{travel:"1"},queryParamsHandling:"merge"})}checkForAppUpdate(){if(typeof window>"u")return;let i=new URL("/version.json",window.location.origin);i.searchParams.set("t",String(Date.now())),fetch(i.toString(),{cache:"no-store",headers:{"cache-control":"no-cache"}}).then(t=>t.ok?t.json():null).then(t=>{if(!t?.version)return;let o="matterya_app_version",n="matterya_update_reload",a=null,r=!1;try{a=window.localStorage.getItem(o),r=window.sessionStorage.getItem(n)===t.version}catch{}if(a&&a!==t.version&&!r){try{"serviceWorker"in navigator&&navigator.serviceWorker.getRegistrations().then(g=>{g.forEach(w=>w.unregister())}),"caches"in window&&caches.keys().then(g=>g.forEach(w=>caches.delete(w)))}catch{}try{window.sessionStorage.setItem(n,t.version)}catch{}let s=new URL(window.location.href);s.searchParams.set("v",t.version),window.location.replace(s.toString());return}try{window.localStorage.setItem(o,t.version),window.sessionStorage.removeItem(n)}catch{}}).catch(()=>{})}acceptCall(){if(!this.incomingCall)return;let{conversationId:i,callType:t,from:o}=this.incomingCall;this.callService.clearIncomingCall(),this.router.navigate(["/messages"],{queryParams:{c:i,call:t,from:o}})}declineCall(){if(!this.incomingCall)return;let{conversationId:i,callId:t}=this.incomingCall;this.callService.sendSignal("call-decline",i,{callId:t}),this.callService.clearIncomingCall()}openNotifications(){let i=this.router.url;if(i.startsWith("/globe")||i==="/"){this.router.navigate([],{queryParams:{panel:"notifications",search:"0"},queryParamsHandling:"merge"});return}this.router.navigate(["/globe"],{queryParams:{panel:"notifications",search:"0"}})}async initNotificationBadge(){try{let i=await this.auth.getUser();if(this.meId=i?.id??null,!this.meId){this.notificationsUnreadCount=0;return}this.notificationEvents.start(this.meId),this.notificationInsertSub?.unsubscribe(),this.notificationUpdateSub?.unsubscribe(),this.notificationInsertSub=this.notificationEvents.insert$.subscribe(()=>{this.refreshNotificationsUnread()}),this.notificationUpdateSub=this.notificationEvents.update$.subscribe(()=>{this.refreshNotificationsUnread()}),this.refreshNotificationsUnread(),this.startNotificationPolling()}catch{}}startNotificationPolling(){this.notificationPollTimer||(this.notificationPollTimer=window.setInterval(()=>{this.refreshNotificationsUnread()},2e4))}async refreshNotificationsUnread(){if(!this.notificationsRefreshInFlight){this.notificationsRefreshInFlight=!0;try{if(!this.meId){this.notificationsUnreadCount=0;return}let{notifications:i}=await this.notifications.list(80),t=(i??[]).filter(o=>!o.read_at&&String(o?.type??"").toLowerCase()!=="message");this.notificationsUnreadCount=t.length}catch{}finally{this.notificationsRefreshInFlight=!1}}}static \u0275fac=function(t){return new(t||e)(h(B),h(P),h(S),h(L),h(j))};static \u0275cmp=U({type:e,selectors:[["app-root"]],decls:4,vars:3,consts:[["type","button","class","global-alert","aria-label","Open alerts",3,"click",4,"ngIf"],["type","button","class","global-travel","aria-label","Travel to a country",3,"click",4,"ngIf"],["class","global-call",4,"ngIf"],["type","button","aria-label","Open alerts",1,"global-alert",3,"click"],["src","/assets/notification.png","alt","",1,"global-alert-icon"],["class","global-alert-badge",4,"ngIf"],[1,"global-alert-badge"],["type","button","aria-label","Travel to a country",1,"global-travel",3,"click"],[1,"global-travel-icon"],[1,"global-call"],[1,"global-call-card"],[1,"global-call-title"],[1,"global-call-actions"],["type","button",1,"global-call-btn","accept",3,"click"],["type","button",1,"global-call-btn","decline",3,"click"]],template:function(t,o){t&1&&(k(0,"router-outlet"),R(1,D,3,1,"button",0)(2,H,3,0,"button",1)(3,$,9,1,"div",2)),t&2&&(u(),C("ngIf",!o.isMessagesRoute&&!o.isProfileRoute&&!o.isReelsRoute),u(),C("ngIf",o.showTravelButton),u(),C("ngIf",o.incomingCall&&!o.isMessagesRoute))},dependencies:[T,O,W],styles:[".global-call[_ngcontent-%COMP%]{position:fixed;inset:0;display:grid;place-items:center;background:#050a128c;-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);z-index:140;padding:16px}.global-call-card[_ngcontent-%COMP%]{width:min(92vw,420px);background:#08101cf5;color:#eef6ff;border-radius:22px;padding:18px;box-shadow:0 20px 50px #00000059;display:flex;flex-direction:column;gap:14px;align-items:center;text-align:center}.global-call-title[_ngcontent-%COMP%]{font-size:16px;font-weight:700}.global-call-actions[_ngcontent-%COMP%]{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}.global-call-btn[_ngcontent-%COMP%]{border:0;border-radius:16px;padding:10px 16px;font-weight:600;cursor:pointer}.global-call-btn.accept[_ngcontent-%COMP%]{background:#2f9d66;color:#fff}.global-call-btn.decline[_ngcontent-%COMP%]{background:#d84c4c;color:#fff}.global-alert[_ngcontent-%COMP%]{position:fixed;top:calc(env(safe-area-inset-top) + 14px);right:16px;width:34px;height:34px;border-radius:12px;border:0;background:transparent;color:#f4f7ff;display:grid;place-items:center;cursor:pointer;z-index:120;box-shadow:none;-webkit-backdrop-filter:none;backdrop-filter:none;padding:0;transition:opacity .2s ease,transform .2s ease}.global-travel[_ngcontent-%COMP%]{position:fixed;top:calc(env(safe-area-inset-top) + 14px);right:56px;width:34px;height:34px;border-radius:12px;border:0;background:transparent;color:#f4f7ff;display:grid;place-items:center;cursor:pointer;z-index:120;padding:0;transition:opacity .2s ease,transform .2s ease}.feed-header-hidden[_nghost-%COMP%]   .global-travel[_ngcontent-%COMP%], .feed-header-hidden   [_nghost-%COMP%]   .global-travel[_ngcontent-%COMP%]{opacity:0;pointer-events:none;transform:translateY(-8px)}.global-travel-icon[_ngcontent-%COMP%]{font-size:20px;line-height:1}.feed-header-hidden[_nghost-%COMP%]   .global-alert[_ngcontent-%COMP%], .feed-header-hidden   [_nghost-%COMP%]   .global-alert[_ngcontent-%COMP%]{opacity:0;pointer-events:none;transform:translateY(-8px)}.global-alert-icon[_ngcontent-%COMP%]{width:26px;height:26px;object-fit:contain;display:block}.global-alert-badge[_ngcontent-%COMP%]{position:absolute;top:-4px;right:-4px;min-width:12px;height:12px;border-radius:999px;background:#389efff2;color:#041629;font-size:7px;font-weight:900;display:grid;place-items:center;padding:0 4px;box-shadow:0 0 0 2px #060a10cc}@media(max-width:640px){.global-alert[_ngcontent-%COMP%]{top:calc(env(safe-area-inset-top) + 10px);right:12px;width:30px;height:30px}.global-travel[_ngcontent-%COMP%]{top:calc(env(safe-area-inset-top) + 10px);right:48px;width:30px;height:30px}.global-travel-icon[_ngcontent-%COMP%]{font-size:18px}.global-alert-badge[_ngcontent-%COMP%]{top:-3px;right:-3px;min-width:11px;height:11px;font-size:7px}.global-alert-icon[_ngcontent-%COMP%]{width:24px;height:24px}}"]})};N(I,{providers:[F(z)]});
